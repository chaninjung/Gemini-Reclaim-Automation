<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Scheduler v2</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%233b82f6' stroke='%231e3a8a' stroke-width='3'/><circle cx='50' cy='50' r='38' fill='white'/><line x1='50' y1='50' x2='50' y2='25' stroke='%231e3a8a' stroke-width='3' stroke-linecap='round'/><line x1='50' y1='50' x2='65' y2='35' stroke='%231e3a8a' stroke-width='3' stroke-linecap='round'/><circle cx='50' cy='20' r='2' fill='%233b82f6'/><circle cx='50' cy='80' r='2' fill='%233b82f6'/><circle cx='20' cy='50' r='2' fill='%233b82f6'/><circle cx='80' cy='50' r='2' fill='%233b82f6'/></svg>">

    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>

    <!-- Toast UI Editor -->
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>

    <!-- Font: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --radius: 0.5rem;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #ffffff;
            color: #09090b;
            /* Zinc-950 */
            -webkit-font-smoothing: antialiased;
        }

        /* Custom Scrollbar (Subtle) */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #e4e4e7;
            border-radius: 99px;
        }

        /* Zinc-200 */
        ::-webkit-scrollbar-thumb:hover {
            background: #d4d4d8;
        }

        /* Zinc-300 */

        /* FullCalendar Shadcn Overrides */
        .fc {
            font-family: 'Inter', sans-serif;
            --fc-border-color: #e4e4e7;
            /* Zinc-200 */
        }

        .fc-theme-standard .fc-scrollgrid {
            border: none !important;
        }

        .fc-theme-standard td,
        .fc-theme-standard th {
            border-color: #e4e4e7 !important;
        }

        .fc-col-header-cell {
            padding: 12px 0;
            background-color: #ffffff;
        }

        .fc-col-header-cell-cushion {
            color: #71717a;
            /* Zinc-500 */
            font-weight: 500;
            font-size: 0.75rem;
            /* text-xs */
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .fc-daygrid-day-number {
            color: #52525b;
            /* Zinc-600 */
            font-size: 0.875rem;
            /* text-sm */
            font-weight: 500;
            padding: 8px;
        }

        .fc-day-today {
            background-color: #fafafa !important;
            /* Zinc-50 */
        }

        /* Shadcn-like Events */
        .fc-event {
            border: 1px solid transparent;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 11px;
            font-weight: 600;
            box-shadow: none;
            transition: all 0.15s ease;
        }



        /* Hide default FullCalendar dots to prevent double dots */
        .fc-daygrid-event-dot {
            display: none !important;
        }

        /* Event Variants */
        /* Restore Dots */
        .event-type-summary .fc-event-title::before {
            content: '';
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #a855f7;
            /* Purple 500 */
            margin-right: 6px;
            margin-bottom: 1px;
        }

        .event-type-task .fc-event-title::before {
            content: '';
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #3b82f6;
            /* Blue 500 */
            margin-right: 6px;
            margin-bottom: 1px;
        }

        .event-type-meeting .fc-event-title::before {
            content: '';
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #10b981;
            /* Emerald 500 */
            margin-right: 6px;
            margin-bottom: 1px;
        }

        .event-type-summary {
            background-color: #f4f4f5 !important;
            /* Zinc-100 */
            border-color: #e4e4e7 !important;
            /* Zinc-200 */
            color: #3f3f46 !important;
            /* Zinc-700 */
            border-left: 3px solid #71717a !important;
            /* Zinc-500 */
        }

        .event-type-task {
            background-color: #eff6ff !important;
            /* Blue-50 */
            border-color: #dbeafe !important;
            color: #1d4ed8 !important;
            /* Blue-700 (Vibrant) */
            border-left: 3px solid #3b82f6 !important;
        }

        .event-type-meeting {
            background-color: #f0fdf4 !important;
            /* Green-50 */
            border-color: #dcfce7 !important;
            color: #15803d !important;
            /* Green-700 (Darker/Vibrant) */
            border-left: 3px solid #22c55e !important;
        }

        /* Status Styles */
        .status-done {
            opacity: 0.5;
            text-decoration: line-through;
        }

        .status-verified {
            border: 2px solid #fbbf24 !important;
            /* Amber-400 */
        }

        .status-verified .fc-event-title::after {
            content: '✓';
            color: #d97706;
            /* Amber-600 */
            margin-left: 4px;
            font-weight: 800;
        }

        /* Ensure text color cascades to inner elements */
        .event-type-meeting .fc-event-main,
        .event-type-task .fc-event-main,
        .event-type-summary .fc-event-main {
            color: inherit !important;
        }

        .fc-toolbar-title {
            font-size: 1.125rem !important;
            font-weight: 600 !important;
            color: #09090b !important;
            letter-spacing: -0.025em;
        }

        .fc-button-primary {
            background-color: white !important;
            border: 1px solid #e4e4e7 !important;
            color: #18181b !important;
            font-weight: 500 !important;
            font-size: 0.875rem !important;
            padding: 0.375rem 0.75rem !important;
            border-radius: 0.375rem !important;
            /* rounded-md */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05) !important;
        }

        .fc-button-primary:hover {
            background-color: #f4f4f5 !important;
            border-color: #e4e4e7 !important;
        }

        .fc-button-active {
            background-color: #f4f4f5 !important;
            border-color: #e4e4e7 !important;
            color: #09090b !important;
        }

        /* Toast UI Editor Clean Override */
        .toastui-editor-defaultUI {
            border: 1px solid #e4e4e7 !important;
            border-radius: 0.5rem !important;
        }

        .toastui-editor-toolbar {
            background-color: #fafafa !important;
            border-bottom: 1px solid #e4e4e7 !important;
            border-radius: 0.5rem 0.5rem 0 0 !important;
        }

        .toastui-editor-defaultUI-toolbar button {
            border-radius: 4px;
        }

        .toastui-editor-defaultUI-toolbar button:hover {
            background-color: #e4e4e7;
        }

        #contextMenu {
            position: absolute;
            z-index: 1000;
            display: none;
            background: white;
            border: 1px solid #e4e4e7;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 4px;
            min-width: 140px;
        }

        /* Typography Utilities */
        .tracking-tight {
            letter-spacing: -0.025em;
        }

        /* Markdown Preview - Linear Style */
        .markdown-preview h1 {
            font-size: 1.25em;
            font-weight: 600;
            color: #09090b;
            margin: 1em 0 0.5em 0;
            letter-spacing: -0.025em;
        }

        .markdown-preview h2 {
            font-size: 1.1em;
            font-weight: 600;
            color: #18181b;
            margin: 1em 0 0.5em 0;
            border-bottom: 1px solid #e4e4e7;
            padding-bottom: 0.3em;
        }

        .markdown-preview p {
            margin-bottom: 0.75em;
            color: #3f3f46;
            line-height: 1.6;
            font-size: 0.925rem;
        }

        .markdown-preview strong {
            color: #09090b;
            font-weight: 600;
        }

        .markdown-preview ul {
            list-style: disc;
            padding-left: 1.25em;
            margin-bottom: 1em;
            color: #3f3f46;
        }

        .markdown-preview li {
            margin-bottom: 0.25em;
        }

        .markdown-preview blockquote {
            border-left: 2px solid #e4e4e7;
            padding-left: 1em;
            color: #71717a;
            margin-left: 0;
            margin-right: 0;
        }



        /* Modal Context Block */
        .context-block {
            background-color: #fafafa;
            border-left: 3px solid #e4e4e7;
            padding: 0.75rem;
            margin-top: 1rem;
            border-radius: 0 0.375rem 0.375rem 0;
            font-size: 0.9em;
            color: #52525b;
        }

        .context-label {
            font-weight: 600;
            color: #3f3f46;
            margin-bottom: 0.25rem;
            display: block;
            text-transform: uppercase;
            font-size: 0.75em;
        }

        /* Animation Utility */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Tooltip Pointer Events Fix */
        .tippy-box {
            pointer-events: none !important;
        }
    </style>
</head>

<body class="bg-background h-screen flex flex-col antialiased text-zinc-950" onclick="hideContextMenu()">

    <!-- Header (Minimalist) -->
    <header
        class="bg-white border-b border-zinc-200 h-14 flex items-center px-6 justify-between flex-shrink-0 z-20 sticky top-0">
        <div class="flex items-center gap-3">
            <div
                class="w-8 h-8 bg-zinc-900 rounded-md flex items-center justify-center text-white text-sm font-bold shadow-sm">
                SS
            </div>
            <div class="flex items-baseline gap-2">
                <h1 class="font-semibold text-sm text-zinc-900 tracking-tight">Smart Scheduler</h1>
                <span class="text-[10px] text-zinc-500 font-medium">v2.0.0</span>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <a href="https://github.com/shadcn/ui" target="_blank"
                class="text-xs text-zinc-500 hover:text-zinc-900 font-medium transition-colors">Documentation</a>
        </div>
    </header>

    <!-- Main Content (Full Height Dashboard) -->
    <main class="flex-1 flex overflow-hidden bg-white">

        <!-- Left Panel: Input Area (Resizable) -->
        <div id="sidebarPanel" style="width: 450px; min-width: 300px; max-width: 800px;"
            class="flex flex-col flex-shrink-0 bg-white shadow-[4px_0_24px_-12px_rgba(0,0,0,0.1)] z-10 relative">
            <div class="p-6 flex-1 overflow-y-auto custom-scrollbar">
                <div class="mb-6">
                    <h2 class="text-lg font-semibold text-zinc-900 tracking-tight mb-1">Meeting Notes</h2>
                    <p class="text-sm text-zinc-500">Paste your raw notes below. AI will structure them.</p>
                </div>

                <!-- Input Area -->
                <div class="relative group mb-4">
                    <textarea id="meetingNotes"
                        class="w-full h-[360px] p-4 bg-zinc-50/50 border border-zinc-200 rounded-md focus:bg-white focus:ring-2 focus:ring-zinc-900/10 focus:border-zinc-300 transition-all resize-none text-sm leading-6 text-zinc-800 placeholder-zinc-400 font-mono outline-none"
                        placeholder="Paste notes here..."></textarea>

                    <div class="absolute bottom-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="openFullscreenEditor('meetingNotes')" type="button"
                            class="text-xs font-medium text-zinc-500 hover:text-zinc-900 transition-colors px-2 py-1 hover:bg-zinc-100 rounded flex items-center gap-1">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                            </svg>
                            <span>크게보기</span>
                        </button>
                    </div>
                </div>

                <button onclick="analyzeNotes()" id="analyzeBtn"
                    class="w-full py-2.5 bg-zinc-900 text-white text-sm font-medium rounded-md hover:bg-zinc-900/90 transition-all shadow-sm flex justify-center items-center gap-2">
                    <span>Analyze Notes</span>
                    <span class="text-zinc-400 text-xs text-zinc-500">⌘↵</span>
                </button>

                <!-- Analysis Preview Stage -->
                <div id="previewStage" class="hidden mt-8 fade-in">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="h-px flex-1 bg-zinc-100"></div>
                        <span class="text-[10px] font-semibold text-zinc-400 uppercase tracking-widest">Preview</span>
                        <div class="h-px flex-1 bg-zinc-100"></div>
                    </div>

                    <!-- Dynamic Content Area -->
                    <div id="summaryPreview" class="w-full space-y-6"></div>

                    <!-- Action -->
                    <div class="mt-6 pt-6 border-t border-zinc-100">
                        <button onclick="applyToCalendar()"
                            class="w-full py-2.5 bg-white border border-zinc-200 text-zinc-900 text-sm font-medium rounded-md hover:bg-zinc-50 transition-all shadow-sm">
                            Add to Calendar
                        </button>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="loadingState" class="hidden mt-12 text-center">
                    <div
                        class="inline-block animate-spin rounded-full h-5 w-5 border-2 border-zinc-200 border-t-zinc-900">
                    </div>
                    <p class="mt-3 text-sm font-medium text-zinc-900">Analyzing...</p>
                </div>
            </div>
        </div>

        <!-- Resizer Handle -->
        <div id="resizer"
            class="w-1 bg-zinc-200 hover:bg-zinc-300 cursor-col-resize flex flex-col justify-center items-center transition-colors z-20 flex-shrink-0 group">
            <div class="h-8 w-1 bg-zinc-300 rounded-full group-hover:bg-zinc-400 transition-colors"></div>
        </div>

        <!-- Right Panel: Calendar -->
        <div class="flex-1 flex flex-col bg-white min-w-0">
            <div class="h-14 border-b border-zinc-200 flex items-center justify-between px-6 bg-white">
                <div class="flex items-center gap-4">
                    <h2 class="text-sm font-semibold text-zinc-900">Calendar</h2>

                    <!-- Category Filters -->
                    <div class="flex items-center gap-1">
                        <button onclick="toggleCategory('ai_req')" id="cat-ai_req"
                            class="cat-btn active px-2 py-0.5 text-[11px] font-bold rounded-full border border-zinc-200 transition-all text-zinc-600 bg-zinc-50 hover:bg-zinc-100 data-[state=inactive]:opacity-50 data-[state=inactive]:line-through">AI
                            Request</button>
                        <button onclick="toggleCategory('dev_prog')" id="cat-dev_prog"
                            class="cat-btn active px-2 py-0.5 text-[11px] font-bold rounded-full border border-zinc-200 transition-all text-zinc-600 bg-zinc-50 hover:bg-zinc-100 data-[state=inactive]:opacity-50 data-[state=inactive]:line-through">Development</button>
                    </div>
                </div>

                <div class="flex items-center gap-3">
                    <!-- Undo/Redo Buttons -->
                    <div class="flex items-center gap-1 mr-2 border-r border-zinc-200 pr-3">
                        <button onclick="undo()" id="btnUndo" disabled
                            class="p-1.5 text-zinc-400 hover:text-zinc-900 hover:bg-zinc-100 rounded-md transition-colors disabled:opacity-30"
                            title="Undo (Ctrl+Z)">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path>
                            </svg>
                        </button>
                        <button onclick="redo()" id="btnRedo" disabled
                            class="p-1.5 text-zinc-400 hover:text-zinc-900 hover:bg-zinc-100 rounded-md transition-colors disabled:opacity-30"
                            title="Redo (Ctrl+Y)">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M21 10h-10a8 8 0 00-8 8v2M21 10l-6 6m6-6l-6-6"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- Clean Filters (Capsule Style with Dots) -->
                    <div class="flex items-center gap-1">
                        <button onclick="toggleFilter('summary')" id="filter-summary"
                            class="active px-2.5 py-0.5 text-[11px] font-bold rounded-full border border-zinc-200 transition-all text-zinc-600 bg-zinc-50 hover:bg-zinc-100 data-[state=inactive]:opacity-50 data-[state=inactive]:line-through flex items-center gap-1.5">
                            <span class="w-1.5 h-1.5 rounded-full bg-purple-500"></span>Summary</button>
                        <button onclick="toggleFilter('task')" id="filter-task"
                            class="active px-2.5 py-0.5 text-[11px] font-bold rounded-full border border-zinc-200 transition-all text-zinc-600 bg-zinc-50 hover:bg-zinc-100 data-[state=inactive]:opacity-50 data-[state=inactive]:line-through flex items-center gap-1.5">
                            <span class="w-1.5 h-1.5 rounded-full bg-blue-500"></span>Tasks</button>
                        <button onclick="toggleFilter('meeting')" id="filter-meeting"
                            class="active px-2.5 py-0.5 text-[11px] font-bold rounded-full border border-zinc-200 transition-all text-zinc-600 bg-zinc-50 hover:bg-zinc-100 data-[state=inactive]:opacity-50 data-[state=inactive]:line-through flex items-center gap-1.5">
                            <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>Meetings</button>
                    </div>
                </div>
            </div>



            <div class="flex-1 p-0 overflow-hidden relative">
                <div id='calendar' class="h-full"></div>
            </div>
        </div>

    </main>

    <!-- Context Menu (Zinc Style) -->
    <div id="contextMenu" class="bg-white rounded-md shadow-lg border border-zinc-200 py-1 w-40 z-50 hidden">
        <button onclick="onClickContextStatus('done')" id="ctxStatusDone"
            class="block w-full text-left px-3 py-1.5 text-xs font-medium text-zinc-700 hover:bg-zinc-100 transition-colors">Mark
            as Done</button>
        <button onclick="onClickContextStatus('verified')" id="ctxStatusVerified"
            class="block w-full text-left px-3 py-1.5 text-xs font-medium text-amber-600 hover:bg-amber-50 transition-colors">Mark
            as Verified</button>
        <button onclick="onClickContextStatus('todo')" id="ctxStatusTodo"
            class="block w-full text-left px-3 py-1.5 text-xs font-medium text-zinc-500 hover:bg-zinc-100 transition-colors">Reset
            to Todo</button>
        <div class="h-px bg-zinc-200 my-1"></div>
        <button onclick="onClickContextEdit()"
            class="block w-full text-left px-3 py-1.5 text-xs font-medium text-zinc-700 hover:bg-zinc-100 transition-colors">Edit</button>
        <button onclick="onClickContextDelete()"
            class="block w-full text-left px-3 py-1.5 text-xs font-medium text-red-600 hover:bg-red-50 transition-colors">Delete</button>
    </div>

    <!-- Read-Only Event View Modal (Zinc Style) -->
    <div id="viewModal"
        class="hidden fixed inset-0 bg-black/20 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div
            class="bg-white rounded-lg shadow-2xl w-[700px] flex flex-col overflow-hidden max-h-[85vh] border border-zinc-200">
            <div class="px-6 py-4 border-b border-zinc-100 flex justify-between items-start bg-white">
                <div>
                    <h3 id="viewEventTitle" class="text-xl font-bold text-zinc-900 leading-tight"></h3>
                    <p id="viewEventTime" class="text-sm text-zinc-500 mt-1 font-mono"></p>
                </div>
                <button onclick="closeModal()"
                    class="text-zinc-400 hover:text-zinc-600 transition-colors p-1 hover:bg-zinc-100 rounded">✕</button>
            </div>

            <div class="flex-1 p-6 overflow-y-auto bg-white custom-scrollbar">
                <div id="viewEventDesc" class="markdown-preview max-w-none text-zinc-700 leading-relaxed"></div>
            </div>

            <div class="px-6 py-4 border-t border-zinc-100 bg-zinc-50/50 flex justify-end gap-3">
                <button onclick="closeModal()"
                    class="px-4 py-2 bg-white border border-zinc-200 text-zinc-700 hover:bg-zinc-50 rounded-md text-sm font-medium transition-colors shadow-sm">Close</button>
                <button onclick="editFromViewModal()"
                    class="px-4 py-2 bg-zinc-900 text-white rounded-md hover:bg-zinc-800 text-sm font-medium shadow-sm flex items-center gap-2 transition-colors">
                    <span>Edit Event</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Enhanced Event Edit Modal (Zinc Style + Type Selector) -->
    <div id="eventModal"
        class="hidden fixed inset-0 bg-black/20 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div
            class="bg-white rounded-lg shadow-2xl w-[800px] h-[80vh] flex flex-col overflow-hidden border border-zinc-200">
            <div class="px-6 py-4 border-b border-zinc-200 flex justify-between items-center bg-zinc-50/50">
                <h3 class="text-sm font-bold text-zinc-900" id="modalTitle">Edit Event</h3>
                <button onclick="closeModal()" class="text-zinc-400 hover:text-zinc-600">✕</button>
            </div>

            <div class="flex-1 flex flex-col p-6 overflow-hidden bg-white">
                <input type="hidden" id="editEventId">

                <div class="grid grid-cols-4 gap-4 mb-4">
                    <div class="col-span-3">
                        <label
                            class="block text-xs font-semibold text-zinc-500 mb-1.5 uppercase tracking-wide">Title</label>
                        <input type="text" id="editEventTitle"
                            class="w-full text-base font-semibold border border-zinc-200 rounded-md px-3 py-2 focus:ring-2 focus:ring-zinc-900/10 focus:border-zinc-300 outline-none text-zinc-900 placeholder-zinc-400"
                            placeholder="Event Title">
                    </div>
                    <div>
                        <label
                            class="block text-xs font-semibold text-zinc-500 mb-1.5 uppercase tracking-wide">Category</label>
                        <select id="editEventCategory"
                            class="w-full text-sm font-medium border border-zinc-200 rounded-md px-3 py-2 bg-white outline-none focus:border-zinc-400 text-zinc-900 cursor-pointer">
                            <option value="ai_req">AI Request</option>
                            <option value="dev_prog">Development</option>
                        </select>
                    </div>
                    <div>
                        <label
                            class="block text-xs font-semibold text-zinc-500 mb-1.5 uppercase tracking-wide">Type</label>
                        <select id="editEventType"
                            class="w-full text-sm font-medium border border-zinc-200 rounded-md px-3 py-2 bg-white outline-none focus:border-zinc-400 text-zinc-900 cursor-pointer">
                            <option value="meeting">Meeting</option>
                            <option value="task">Task</option>
                            <option value="summary">Summary</option>
                        </select>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-xs font-semibold text-zinc-500 mb-1.5 uppercase tracking-wide">Linked
                        Context (Optional)</label>
                    <select id="editEventSourceId"
                        class="w-full text-sm border border-zinc-200 rounded-md px-3 py-2 bg-white outline-none focus:border-zinc-400 text-zinc-700">
                        <option value="">-- No Context Link --</option>
                    </select>
                    <p class="text-xs text-zinc-400 mt-1">Link this event to a meeting summary for context</p>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div>
                        <label
                            class="block text-xs font-semibold text-zinc-500 mb-1.5 uppercase tracking-wide">Start</label>
                        <input type="datetime-local" id="editEventStart"
                            class="w-full text-sm border border-zinc-200 rounded-md px-3 py-2 bg-white outline-none focus:border-zinc-400 font-mono text-zinc-600">
                    </div>
                    <div>
                        <label
                            class="block text-xs font-semibold text-zinc-500 mb-1.5 uppercase tracking-wide">End</label>
                        <input type="datetime-local" id="editEventEnd"
                            class="w-full text-sm border border-zinc-200 rounded-md px-3 py-2 bg-white outline-none focus:border-zinc-400 font-mono text-zinc-600">
                    </div>
                </div>

                <div class="flex-1 flex flex-col min-h-0 border-t border-zinc-100 pt-4">
                    <label
                        class="block text-xs font-semibold text-zinc-500 mb-2 uppercase tracking-wide">Description</label>
                    <div id="editor" class="flex-1 border border-zinc-200 rounded-md overflow-hidden"></div>
                </div>
            </div>

            <div class="px-6 py-4 border-t border-zinc-200 bg-zinc-50/50 flex justify-between items-center">
                <button onclick="deleteEvent()" id="btnDeleteEvent"
                    class="text-red-600 text-xs hover:text-red-700 font-medium px-2 hover:bg-red-50 py-1.5 rounded transition-colors">Delete
                    Event</button>
                <div class="flex gap-3">
                    <button onclick="closeModal()"
                        class="px-4 py-2 bg-white border border-zinc-200 text-zinc-700 hover:bg-zinc-50 rounded-md text-sm font-medium shadow-sm transition-colors">Cancel</button>
                    <button onclick="saveEventChanges()"
                        class="px-4 py-2 bg-zinc-900 text-white rounded-md hover:bg-zinc-800 text-sm font-medium shadow-sm transition-colors">Save
                        Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Fullscreen Editor Modal -->
    <div id="fullscreenEditorModal"
        class="hidden fixed inset-0 bg-zinc-900/95 backdrop-blur-sm z-[100] flex items-center justify-center p-8">
        <div class="bg-white rounded-lg shadow-2xl w-full h-full flex flex-col overflow-hidden border border-zinc-200">
            <div class="px-6 py-4 border-b border-zinc-200 flex justify-between items-center bg-zinc-50/50">
                <h3 class="text-sm font-bold text-zinc-900" id="fullscreenEditorTitle">Editor</h3>
                <button onclick="closeFullscreenEditor()" class="text-zinc-400 hover:text-zinc-600">✕</button>
            </div>

            <div class="flex-1 p-6 overflow-hidden bg-white">
                <textarea id="fullscreenEditorContent"
                    class="w-full h-full p-4 bg-zinc-50/50 border border-zinc-200 rounded-md focus:bg-white focus:ring-2 focus:ring-zinc-900/10 focus:border-zinc-300 transition-all resize-none text-sm leading-6 text-zinc-800 placeholder-zinc-400 font-mono outline-none"></textarea>
            </div>

            <div class="px-6 py-4 border-t border-zinc-200 bg-zinc-50/50 flex justify-end gap-3">
                <button onclick="closeFullscreenEditor()"
                    class="px-4 py-2 bg-white border border-zinc-200 text-zinc-700 hover:bg-zinc-50 rounded-md text-sm font-medium shadow-sm transition-colors">Cancel</button>
                <button onclick="saveFullscreenContent()"
                    class="px-4 py-2 bg-zinc-900 text-white rounded-md hover:bg-zinc-800 text-sm font-medium shadow-sm transition-colors">Save</button>
            </div>
        </div>
    </div>

    <script>
        let calendar;
        let editor;
        const STORAGE_KEY_EVENTS = 'smart_scheduler_events';
        const STORAGE_KEY_NOTES = 'smart_scheduler_notes';
        let tempAnalysisResult = null;
        let activeEvent = null;
        let contextEvent = null;

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        }

        let fullscreenEditorSourceId = null;



        // --- Undo/Redo System ---
        const historyStack = [];
        const redoStack = [];
        const MAX_HISTORY = 50;
        let isUndoRedoAction = false; // Flag to prevent pushing history during undo/redo

        function pushHistory() {
            if (isUndoRedoAction) return;

            // Snapshot current events
            const snapshot = calendar.getEvents().map(e => {
                return {
                    id: e.id,
                    title: e.title,
                    start: e.startStr,
                    end: e.endStr,
                    allDay: e.allDay,
                    extendedProps: { ...e.extendedProps }
                };
            });

            historyStack.push(snapshot);
            if (historyStack.length > MAX_HISTORY) historyStack.shift();

            // Clear redo stack on new action
            redoStack.length = 0;
            updateUndoRedoUI();
        }

        function restoreSnapshot(snapshot) {
            isUndoRedoAction = true;
            calendar.removeAllEvents();
            snapshot.forEach(eventData => {
                calendar.addEvent(eventData);
            });
            // Persist to storage without pushing history again
            const events = calendar.getEvents().map(e => {
                return {
                    id: e.id,
                    title: e.title,
                    start: e.start ? e.start.toISOString() : null,
                    end: e.end ? e.end.toISOString() : null,
                    allDay: e.allDay,
                    description: e.extendedProps.description,
                    extendedProps: e.extendedProps
                };
            });
            saveToLocalStorageAPI(events); // Helper function needed or direct save
            isUndoRedoAction = false;
        }

        // Separate save function that doesn't push history (for undo/redo internal use)
        function saveToLocalStorageAPI(events) {
            fetch('/api/db', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ events: events })
            }).catch(err => console.error("Auto-save failed", err));
        }

        function undo() {
            if (historyStack.length === 0) return;

            // Save current state to redo stack before undoing
            const currentSnapshot = calendar.getEvents().map(e => ({
                id: e.id,
                title: e.title,
                start: e.startStr,
                end: e.endStr,
                allDay: e.allDay,
                extendedProps: { ...e.extendedProps }
            }));
            redoStack.push(currentSnapshot);

            const previousSnapshot = historyStack.pop();
            restoreSnapshot(previousSnapshot);
            updateUndoRedoUI();
            showToast("Undo Successful");
        }

        function redo() {
            if (redoStack.length === 0) return;

            // Save current state to history stack before redoing
            const currentSnapshot = calendar.getEvents().map(e => ({
                id: e.id,
                title: e.title,
                start: e.startStr,
                end: e.endStr,
                allDay: e.allDay,
                extendedProps: { ...e.extendedProps }
            }));
            historyStack.push(currentSnapshot);

            const nextSnapshot = redoStack.pop();
            restoreSnapshot(nextSnapshot);
            updateUndoRedoUI();
            showToast("Redo Successful");
        }

        function updateUndoRedoUI() {
            const btnUndo = document.getElementById('btnUndo');
            const btnRedo = document.getElementById('btnRedo');

            if (btnUndo) {
                btnUndo.disabled = historyStack.length === 0;
                btnUndo.classList.toggle('text-zinc-900', historyStack.length > 0);
                btnUndo.classList.toggle('text-zinc-400', historyStack.length === 0);
            }
            if (btnRedo) {
                btnRedo.disabled = redoStack.length === 0;
                btnRedo.classList.toggle('text-zinc-900', redoStack.length > 0);
                btnRedo.classList.toggle('text-zinc-400', redoStack.length === 0);
            }
        }

        function showToast(message) {
            // Simple toast implementation
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-zinc-800 text-white px-4 py-2 rounded-full text-sm font-medium shadow-lg z-50 fade-in';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        // Keyboard Shortcuts
        document.addEventListener('keydown', function (e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                e.preventDefault();
                if (e.shiftKey) redo();
                else undo();
            } else if ((e.ctrlKey || e.metaKey) && e.key === 'y') {
                e.preventDefault();
                redo();
            }
        });

        function openFullscreenEditor(sourceId) {
            fullscreenEditorSourceId = sourceId;
            const sourceElement = document.getElementById(sourceId);
            const modal = document.getElementById('fullscreenEditorModal');
            const content = document.getElementById('fullscreenEditorContent');
            const title = document.getElementById('fullscreenEditorTitle');

            content.value = sourceElement.value;
            title.textContent = sourceId === 'meetingNotes' ? 'Meeting Notes - 크게보기' : 'Summary Content - 크게보기';
            modal.classList.remove('hidden');
            content.focus();
        }

        function closeFullscreenEditor() {
            document.getElementById('fullscreenEditorModal').classList.add('hidden');
            fullscreenEditorSourceId = null;
        }

        function saveFullscreenContent() {
            if (fullscreenEditorSourceId) {
                const content = document.getElementById('fullscreenEditorContent').value;
                document.getElementById(fullscreenEditorSourceId).value = content;
                closeFullscreenEditor();
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            editor = new toastui.Editor({
                el: document.querySelector('#editor'),
                height: '100%',
                initialEditType: 'markdown',
                previewStyle: 'vertical'
            });

            loadDataFromServer();

            var calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                views: { dayGridMonth: { displayEventTime: false } },
                locale: 'ko',
                slotMinTime: '08:00:00',
                slotMaxTime: '22:00:00',
                allDaySlot: false,
                nowIndicator: true,
                height: '100%',
                expandRows: true,
                editable: true,
                droppable: true,
                selectable: true,
                dateClick: function (info) {
                    if (window.clickTimer) {
                        clearTimeout(window.clickTimer);
                        window.clickTimer = null;
                        openCreateModal(info.dateStr);
                    } else {
                        window.clickTimer = setTimeout(() => {
                            window.clickTimer = null;
                        }, 250);
                    }
                },
                events: [],
                eventClassNames: function (arg) {
                    const classes = [];
                    // Type Classes
                    if (arg.event.extendedProps.isSummary) classes.push('event-type-summary');
                    else if (arg.event.extendedProps.isTask) classes.push('event-type-task');
                    else classes.push('event-type-meeting');

                    // Category Classes (Default to ai_req if missing)
                    const cat = arg.event.extendedProps.category || 'ai_req';
                    classes.push('cat-' + cat);

                    // Status Classes
                    const status = arg.event.extendedProps.status || 'todo';
                    classes.push('status-' + status);

                    return classes;
                },
                eventDidMount: function (info) {
                    // Direct handler - strongest way to prevent default
                    info.el.oncontextmenu = function (e) {
                        e.preventDefault();
                        e.stopPropagation();
                        showContextMenu(e, info.event);
                        return false;
                    };

                    tippy(info.el, {
                        content: `<div class="text-xs font-sans text-zinc-100">${info.event.title}</div>`,
                        theme: 'translucent',
                        allowHTML: true,
                    });
                },
                eventDragStart: function (info) {
                    pushHistory();
                },
                eventResizeStart: function (info) {
                    pushHistory();
                },
                eventDrop: function () { saveEventsToStorage(); },
                eventResize: function () { saveEventsToStorage(); },
                eventClick: function (info) { showReadOnlyModal(info); }
            });
            calendar.render();

            // Resizer Logic
            const resizer = document.getElementById('resizer');
            const sidebar = document.getElementById('sidebarPanel');
            let isResizing = false;

            resizer.addEventListener('mousedown', function (e) {
                isResizing = true;
                document.body.style.cursor = 'col-resize';
                resizer.classList.add('bg-zinc-300');
            });

            document.addEventListener('mousemove', function (e) {
                if (!isResizing) return;
                const newWidth = e.clientX;
                if (newWidth > 300 && newWidth < 800) {
                    sidebar.style.width = newWidth + 'px';
                }
            });

            document.addEventListener('mouseup', function (e) {
                if (isResizing) {
                    isResizing = false;
                    document.body.style.cursor = 'default';
                    resizer.classList.remove('bg-zinc-300');
                    if (calendar) setTimeout(() => calendar.updateSize(), 50); // Refresh calendar
                }
            });


            // Auto-resize notes area debounce
            let notesTimeout;
            document.getElementById('meetingNotes').addEventListener('input', function (e) {
                clearTimeout(notesTimeout);
                notesTimeout = setTimeout(() => { saveDataToServer({ meeting_notes: e.target.value }); }, 1000);
            });
        });

        // Server Logic 
        async function loadDataFromServer() {
            try {
                const response = await fetch('/api/db');
                const result = await response.json();
                if (result.success) {
                    if (result.data.meeting_notes) document.getElementById('meetingNotes').value = result.data.meeting_notes;
                    if (result.data.events) {
                        calendar.removeAllEvents();
                        calendar.addEventSource(result.data.events);

                        // ID Migration for legacy data
                        let needsSave = false;
                        calendar.getEvents().forEach(e => {
                            if (!e.id) {
                                e.setProp('id', generateId());
                                needsSave = true;
                            }
                        });

                        if (needsSave) {
                            console.log("Migrating legacy events with new IDs...");
                            saveEventsToStorage();
                        }
                    }
                }
            } catch (error) { console.error('Failed to load data:', error); }
        }

        async function saveDataToServer(data) {
            try {
                await fetch('/api/db', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            } catch (error) { console.error('Failed to save data:', error); }
        }

        // Context Menu Logic
        function showContextMenu(e, event) {
            contextEvent = event;
            const menu = document.getElementById('contextMenu');
            menu.classList.remove('hidden');
            menu.style.display = 'block';
            menu.style.left = e.pageX + 'px';
            menu.style.top = e.pageY + 'px';
        }
        function hideContextMenu() {
            const menu = document.getElementById('contextMenu');
            menu.classList.add('hidden');
            menu.style.display = 'none';
        }
        function onClickContextStatus(newStatus) {
            if (contextEvent) {
                pushHistory(); // Save state before status change
                contextEvent.setExtendedProp('status', newStatus);
                saveEventsToStorage();
            }
            hideContextMenu();
        }
        function onClickContextEdit() { if (contextEvent) openEditModal(contextEvent); hideContextMenu(); }
        function onClickContextDelete() {
            if (contextEvent && confirm('Delete this event?')) {
                pushHistory(); // Save state before delete
                contextEvent.remove();
                saveEventsToStorage();
                checkSyncButtonState();
            }
            hideContextMenu();
        }

        // Modals
        function openCreateModal(dateStr) {
            activeEvent = null;
            document.getElementById('editEventId').value = '';
            document.getElementById('editEventTitle').value = '';
            document.getElementById('modalTitle').innerText = 'New Event';
            document.getElementById('editEventType').value = 'meeting'; // Default
            document.getElementById('editEventCategory').value = 'ai_req'; // Default category

            // Default time handling
            let startDate = new Date();
            if (dateStr) {
                // If date clicked, use that date + 09:00 AM (default start of day) or current time if today
                startDate = new Date(dateStr);
                // Adjust to local 9 AM for better UX on day click
                startDate.setHours(9, 0, 0, 0);
            } else {
                // If button clicked, next 30 min slot
                startDate.setMinutes(Math.ceil(startDate.getMinutes() / 30) * 30, 0, 0);
            }

            const toLocalISO = (date) => {
                const tzOffset = date.getTimezoneOffset() * 60000;
                return (new Date(date - tzOffset)).toISOString().slice(0, 16);
            };

            document.getElementById('editEventStart').value = toLocalISO(startDate);
            document.getElementById('editEventEnd').value = toLocalISO(new Date(startDate.getTime() + 3600000)); // +1 hour
            editor.setMarkdown('');

            // Hide delete during creation
            const delBtn = document.getElementById('btnDeleteEvent');
            if (delBtn) delBtn.classList.add('hidden');

            document.getElementById('eventModal').classList.remove('hidden');
            populateSourceIdDropdown();
            setTimeout(() => editor.refresh(), 100);
        }

        function openEditModal(event) {
            activeEvent = event;
            document.getElementById('editEventId').value = event.id;
            document.getElementById('editEventTitle').value = event.title;
            document.getElementById('modalTitle').innerText = 'Edit Event';

            // Set Type
            let type = 'meeting';
            if (event.extendedProps.isTask) type = 'task';
            else if (event.extendedProps.isSummary) type = 'summary';
            document.getElementById('editEventType').value = type;

            // Set Category
            document.getElementById('editEventCategory').value = event.extendedProps.category || 'ai_req';

            const toLocalISO = (date) => {
                const tzOffset = date.getTimezoneOffset() * 60000;
                return (new Date(date - tzOffset)).toISOString().slice(0, 16);
            };
            document.getElementById('editEventStart').value = toLocalISO(event.start);
            document.getElementById('editEventEnd').value = event.end ? toLocalISO(event.end) : toLocalISO(new Date(event.start.getTime() + 3600000));
            editor.setMarkdown(event.extendedProps.description || '');

            // Populate and set sourceId dropdown
            populateSourceIdDropdown();
            document.getElementById('editEventSourceId').value = event.extendedProps.sourceId || '';

            // Show delete
            const delBtn = document.getElementById('btnDeleteEvent');
            if (delBtn) delBtn.classList.remove('hidden');

            document.getElementById('eventModal').classList.remove('hidden');
            setTimeout(() => editor.refresh(), 100);
        }

        function populateSourceIdDropdown() {
            const dropdown = document.getElementById('editEventSourceId');
            dropdown.innerHTML = '<option value="">-- No Context Link --</option>';

            const summaries = calendar.getEvents().filter(e => e.extendedProps.isSummary);
            summaries.forEach(s => {
                const option = document.createElement('option');
                option.value = s.id;  // Use Summary's unique ID
                option.textContent = s.title;
                dropdown.appendChild(option);
            });
        }

        function showReadOnlyModal(info) {
            activeEvent = info.event;
            document.getElementById('viewEventTitle').innerText = activeEvent.title;

            const options = { year: 'numeric', month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            const startStr = activeEvent.start.toLocaleString(undefined, options);
            const endStr = activeEvent.end ? activeEvent.end.toLocaleString(undefined, options) : '';
            document.getElementById('viewEventTime').innerText = startStr + (endStr ? ' - ' + endStr : '');

            // Safe Markdown Parsing
            let desc = activeEvent.extendedProps.description || '';
            const safeParse = (text) => {
                try {
                    if (typeof marked !== 'undefined') {
                        if (typeof marked.parse === 'function') return marked.parse(text);
                        if (typeof marked === 'function') return marked(text);
                    }
                    return text.replace(/\\n/g, '<br>');
                } catch (e) { return text.replace(/\\n/g, '<br>'); }
            };

            // Context parsing
            if (desc.includes('[Context]')) {
                const parts = desc.split('[Context]');
                const mainContent = safeParse(parts[0].trim());
                const contextContent = parts[1] ? parts[1].trim() : '';
                desc = `<div>${mainContent}</div>
                <div class="mt-4 p-3 bg-zinc-50 rounded border border-zinc-100">
                    <span class="text-[10px] font-bold text-zinc-400 uppercase tracking-wider block mb-1">Original Text</span>
                    <div class="text-xs text-zinc-600 italic">"${contextContent}"</div>
                </div>`;
            } else {
                desc = safeParse(desc);
            }

            // Link to Source Summary
            if (activeEvent.extendedProps.sourceId && !activeEvent.extendedProps.isSummary) {
                const summaryEvent = calendar.getEvents().find(e =>
                    e.extendedProps.isSummary &&
                    e.id &&
                    e.id === activeEvent.extendedProps.sourceId
                );
                if (summaryEvent) {
                    desc += `<div class="mt-4 pt-4 border-t border-zinc-100">
                        <span class="text-[10px] font-bold text-zinc-400 uppercase tracking-wider block mb-1">Context</span>
                        <div>
                            <a href="#" onclick="openSummary('${summaryEvent.id}'); return false;" class="text-sm text-zinc-900 hover:text-blue-600 hover:underline font-medium inline-flex items-center gap-1 group">
                                <span class="group-hover:scale-110 transition-transform">📄</span>
                                ${summaryEvent.title}
                            </a>
                        </div>
                     </div>`;
                }
            }

            document.getElementById('viewEventDesc').innerHTML = desc;
            document.getElementById('viewModal').classList.remove('hidden');
        }

        function openSummary(id) {
            const event = calendar.getEventById(id);
            if (event) showReadOnlyModal({ event: event });
        }

        function closeModal() {
            document.getElementById('eventModal').classList.add('hidden');
            document.getElementById('viewModal').classList.add('hidden');
            activeEvent = null;
        }

        function saveEventChanges() {
            pushHistory(); // Save state before changes
            const newTitle = document.getElementById('editEventTitle').value;
            const newDesc = editor.getMarkdown();
            const newStart = new Date(document.getElementById('editEventStart').value);
            const newEnd = new Date(document.getElementById('editEventEnd').value);
            const newType = document.getElementById('editEventType').value;
            const newCategory = document.getElementById('editEventCategory').value;

            if (!newTitle.trim()) { alert('Please enter a title'); return; }

            const props = {
                description: newDesc,
                isMeeting: newType === 'meeting',
                isTask: newType === 'task',
                isSummary: newType === 'summary',
                category: newCategory,
                status: 'todo',
                sourceId: document.getElementById('editEventSourceId').value || undefined
            };

            if (activeEvent) {
                // Update
                activeEvent.setProp('title', newTitle);
                activeEvent.setExtendedProp('description', newDesc);

                // Explicitly update all boolean props to ensure reactivity
                activeEvent.setExtendedProp('isMeeting', props.isMeeting);
                activeEvent.setExtendedProp('isTask', props.isTask);
                activeEvent.setExtendedProp('isSummary', props.isSummary);
                activeEvent.setExtendedProp('category', props.category);
                activeEvent.setExtendedProp('sourceId', props.sourceId);

                activeEvent.setStart(newStart);
                activeEvent.setEnd(newEnd);
            } else {
                // Create
                calendar.addEvent({
                    title: newTitle,
                    start: newStart,
                    end: newEnd,
                    description: newDesc,
                    extendedProps: props
                });
            }
            // Goto date
            calendar.gotoDate(newStart);
            saveEventsToStorage();

            // Force close modal
            document.getElementById('eventModal').classList.add('hidden');
            activeEvent = null;
        }

        function deleteEvent() {
            if (activeEvent && confirm('Delete this event?')) {
                pushHistory(); // Save state before delete
                activeEvent.remove();
                saveEventsToStorage();
                checkSyncButtonState();
                closeModal();
            }
        }
        function editFromViewModal() {
            if (activeEvent) {
                document.getElementById('viewModal').classList.add('hidden');
                openEditModal(activeEvent);
            }
        }

        function saveEventsToStorage() {
            const events = calendar.getEvents().map(e => ({
                id: e.id,
                title: e.title,
                start: e.startStr,
                end: e.endStr,
                color: e.backgroundColor,
                extendedProps: e.extendedProps
            }));
            saveDataToServer({ events: events });
        }

        function toggleFilter(type) {
            const btn = document.getElementById('filter-' + type);
            const isActive = btn.classList.contains('active');

            if (isActive) {
                btn.classList.remove('active');
                btn.classList.add('inactive');
                btn.setAttribute('data-state', 'inactive');
            } else {
                btn.classList.remove('inactive');
                btn.classList.add('active');
                btn.removeAttribute('data-state');
            }

            const isSummaryHidden = document.getElementById('filter-summary').classList.contains('inactive');
            const isTaskHidden = document.getElementById('filter-task').classList.contains('inactive');
            const isMeetingHidden = document.getElementById('filter-meeting').classList.contains('inactive');

            const styleId = 'filter-styles';
            let styleEl = document.getElementById(styleId);
            if (!styleEl) {
                styleEl = document.createElement('style');
                styleEl.id = styleId;
                document.head.appendChild(styleEl);
            }

            let css = '';
            if (isSummaryHidden) css += '.event-type-summary {display: none !important; } ';
            if (isTaskHidden) css += '.event-type-task {display: none !important; } ';
            if (isMeetingHidden) css += '.event-type-meeting {display: none !important; } ';

            styleEl.innerHTML = css;
        }

        function toggleCategory(cat) {
            const btn = document.getElementById('cat-' + cat);
            const isActive = btn.classList.contains('active');

            if (isActive) {
                btn.classList.remove('active');
                btn.setAttribute('data-state', 'inactive');
            } else {
                btn.classList.add('active');
                btn.removeAttribute('data-state');
            }
            updateCategoryFilter();
        }

        function updateCategoryFilter() {
            const isAiReqActive = document.getElementById('cat-ai_req').classList.contains('active');
            const isDevProgActive = document.getElementById('cat-dev_prog').classList.contains('active');

            const styleId = 'cat-filter-styles';
            let styleEl = document.getElementById(styleId);
            if (!styleEl) {
                styleEl = document.createElement('style');
                styleEl.id = styleId;
                document.head.appendChild(styleEl);
            }

            let css = '';
            if (!isAiReqActive) css += '.fc-event.cat-ai_req { display: none !important; } ';
            if (!isDevProgActive) css += '.fc-event.cat-dev_prog { display: none !important; } ';

            styleEl.innerHTML = css;
        }

        async function analyzeNotes() {
            const notes = document.getElementById('meetingNotes').value;
            if (!notes.trim()) { alert('Please enter notes.'); return; }

            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('previewStage').classList.add('hidden');

            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `meeting_notes=${encodeURIComponent(notes)}&auto_sync=false`
                });

                const data = await response.json();
                if (data.success) {
                    tempAnalysisResult = data.analysis;
                    document.getElementById('previewStage').classList.remove('hidden');
                    renderStagingArea(data.analysis);
                } else { alert('Error: ' + data.error); }
            } catch (error) { alert('Server Error: ' + error); }
            finally {
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('analyzeBtn').disabled = false;
            }
        }

        function renderStagingArea(analysis) {
            const container = document.getElementById('summaryPreview');
            container.innerHTML = '';

            // 1. Summary
            const summaryHTML = `
                                    <div class="mb-6 rounded-md border border-zinc-200 bg-zinc-50/50 p-4">
                                        <div class="flex items-center justify-between mb-3">
                                            <div class="flex items-center gap-2">
                                                <input type="checkbox" id="checkSummary" checked class="w-4 h-4 rounded border-zinc-300 text-zinc-900 focus:ring-zinc-900">
                                                    <h4 class="text-sm font-semibold text-zinc-900">Meeting Summary</h4>
                                            </div>
                                            <span class="text-[10px] uppercase font-bold text-zinc-400">Markdown</span>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="block text-xs font-semibold text-zinc-500 mb-1.5 uppercase tracking-wide">Title</label>
                                            <input type="text" id="editSummaryTitle" value="${analysis.meeting_title || 'Meeting Summary'}" 
                                                class="w-full text-sm bg-white border border-zinc-200 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-zinc-200 text-zinc-900 font-medium">
                                        </div>
                                        
                                            <input type="date" id="editSummaryDate" value="${analysis.meeting_date || new Date().toISOString().slice(0, 10)}" 
                                                class="w-full text-sm bg-white border border-zinc-200 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-zinc-200 text-zinc-700 font-mono">
                                        </div>

                                        <div class="mb-3">
                                            <label class="block text-xs font-semibold text-zinc-500 mb-1.5 uppercase tracking-wide">Category</label>
                                            <select id="batchCategory" class="w-full text-sm bg-white border border-zinc-200 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-zinc-200 text-zinc-700 font-medium">
                                                <option value="ai_req">AI Request</option>
                                                <option value="dev_prog">Development</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-xs font-semibold text-zinc-500 mb-1.5 uppercase tracking-wide">Content</label>
                                            <div class="relative group">
                                                <textarea id="editSummary" class="w-full h-64 text-sm bg-white border border-zinc-200 rounded p-3 focus:outline-none focus:ring-2 focus:ring-zinc-200 text-zinc-700 font-mono">${analysis.summary}</textarea>
                                                <div class="absolute bottom-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <button onclick="openFullscreenEditor('editSummary')" type="button"
                                                        class="text-xs font-medium text-zinc-500 hover:text-zinc-900 transition-colors px-2 py-1 hover:bg-zinc-100 rounded flex items-center gap-1">
                                                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/>
                                                        </svg>
                                                        <span>크게보기</span>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    `;
            container.innerHTML += summaryHTML;

            // Defaults
            let baseDate = new Date();
            baseDate.setDate(baseDate.getDate() + 1);
            baseDate.setHours(10, 0, 0, 0);
            const defaultDateStr = baseDate.toISOString().slice(0, 10);
            const defaultTimeStr = "10:00";

            // 2. Tasks
            if (analysis.todo_tasks && analysis.todo_tasks.length > 0) {
                let taskHTML = `<div class="mb-4"><h4 class="text-xs font-semibold text-zinc-500 uppercase tracking-wider mb-2">Tasks (${analysis.todo_tasks.length})</h4><div class="space-y-2">`;
                analysis.todo_tasks.forEach((task, idx) => {
                    const dVal = task.deadline || defaultDateStr;
                    taskHTML += `
                                            <div class="flex items-start gap-3 p-3 bg-white border border-zinc-100 rounded-md shadow-sm group hover:border-zinc-300 transition-colors">
                                                <input type="checkbox" id="checkTask_${idx}" checked class="mt-1 w-4 h-4 rounded border-zinc-300 text-zinc-900 focus:ring-zinc-900">
                                                    <div class="flex-1 min-w-0">
                                                        <input type="text" id="valTaskTitle_${idx}" value="${task.title}" class="w-full text-sm font-medium text-zinc-900 bg-transparent border-none p-0 focus:ring-0 placeholder-zinc-300 mb-1">
                                                            <input type="text" id="valTaskDesc_${idx}" value="${task.description}" class="w-full text-xs text-zinc-500 bg-transparent border-none p-0 focus:ring-0 placeholder-zinc-300">
                                                                <input type="hidden" id="valTaskContext_${idx}" value="${task.context || ''}">
                                                                    <div class="flex gap-2 mt-2">
                                                                        <input type="date" id="valTaskDate_${idx}" value="${dVal}" class="text-[10px] bg-zinc-50 border border-zinc-200 rounded px-1 text-zinc-600 outline-none">
                                                                            <input type="time" id="valTaskTime_${idx}" value="${defaultTimeStr}" class="text-[10px] bg-zinc-50 border border-zinc-200 rounded px-1 text-zinc-600 outline-none">
                                                                            </div>
                                                                    </div>
                                                                </div>
                                                                `;
                });
                taskHTML += `</div></div>`;
                container.innerHTML += taskHTML;
            }

            // 3. Meetings
            if (analysis.schedule_items && analysis.schedule_items.length > 0) {
                let meetHTML = `<div class="mb-4"><h4 class="text-xs font-semibold text-zinc-500 uppercase tracking-wider mb-2">Meetings (${analysis.schedule_items.length})</h4><div class="space-y-2">`;
                analysis.schedule_items.forEach((item, idx) => {
                    const dVal = item.date || defaultDateStr;
                    const tVal = item.time || defaultTimeStr;
                    meetHTML += `
                                                            <div class="flex items-start gap-3 p-3 bg-white border border-zinc-100 rounded-md shadow-sm group hover:border-zinc-300 transition-colors">
                                                                <input type="checkbox" id="checkSched_${idx}" checked class="mt-1 w-4 h-4 rounded border-zinc-300 text-zinc-900 focus:ring-zinc-900">
                                                                    <div class="flex-1 min-w-0">
                                                                        <input type="text" id="valSchedTitle_${idx}" value="${item.title}" class="w-full text-sm font-medium text-zinc-900 bg-transparent border-none p-0 focus:ring-0 placeholder-zinc-300 mb-1">
                                                                            <input type="text" id="valSchedDesc_${idx}" value="${item.description}" class="w-full text-xs text-zinc-500 bg-transparent border-none p-0 focus:ring-0 placeholder-zinc-300">
                                                                                <div class="flex gap-2 mt-2">
                                                                                    <input type="date" id="valSchedDate_${idx}" value="${dVal}" class="text-[10px] bg-zinc-50 border border-zinc-200 rounded px-1 text-zinc-600 outline-none">
                                                                                        <input type="time" id="valSchedTime_${idx}" value="${tVal}" class="text-[10px] bg-zinc-50 border border-zinc-200 rounded px-1 text-zinc-600 outline-none">
                                                                                        </div>
                                                                                        <input type="hidden" id="valSchedContext_${idx}" value="${item.context || ''}">
                                                                                        </div>
                                                                                </div>
                                                                                `;
                });
                meetHTML += `</div></div>`;
                container.innerHTML += meetHTML;
            }
        }

        function applyToCalendar() {
            if (!tempAnalysisResult) return;
            pushHistory(); // Save state before batch add

            const finalData = { ...tempAnalysisResult };
            const batchId = Date.now().toString(36) + Math.random().toString(36).substr(2);
            const meetingTitle = document.getElementById('editSummaryTitle')?.value || tempAnalysisResult.meeting_title || 'Meeting Summary';
            const batchCategory = document.getElementById('batchCategory')?.value || 'ai_req';

            // Summary
            const summaryCheck = document.getElementById('checkSummary');
            if (summaryCheck && summaryCheck.checked) {
                finalData.summary = document.getElementById('editSummary').value;
                finalData.summaryDate = document.getElementById('editSummaryDate').value;
                finalData.includeSummary = true;
            } else { finalData.includeSummary = false; }

            // Tasks
            finalData.todo_tasks = [];
            if (tempAnalysisResult.todo_tasks) {
                tempAnalysisResult.todo_tasks.forEach((_, idx) => {
                    if (document.getElementById(`checkTask_${idx}`)?.checked) {
                        const title = document.getElementById(`valTaskTitle_${idx}`).value;
                        const desc = document.getElementById(`valTaskDesc_${idx}`).value;
                        const ctx = document.getElementById(`valTaskContext_${idx}`).value;
                        finalData.todo_tasks.push({
                            title: title,
                            description: ctx ? `${desc}\n\n[Context]\n${ctx}` : desc,
                            date: document.getElementById(`valTaskDate_${idx}`).value,
                            time: document.getElementById(`valTaskTime_${idx}`).value,
                            sourceId: batchId,
                            sourceTitle: meetingTitle
                        });
                    }
                });
            }

            // Meetings
            finalData.schedule_items = [];
            if (tempAnalysisResult.schedule_items) {
                tempAnalysisResult.schedule_items.forEach((_, idx) => {
                    if (document.getElementById(`checkSched_${idx}`)?.checked) {
                        const title = document.getElementById(`valSchedTitle_${idx}`).value;
                        const date = document.getElementById(`valSchedDate_${idx}`).value;
                        const time = document.getElementById(`valSchedTime_${idx}`).value;
                        finalData.schedule_items.push({
                            title: title,
                            date: date, time: time,
                            description: document.getElementById(`valSchedDesc_${idx}`).value,
                            duration_minutes: 60,
                            sourceId: batchId,
                            sourceTitle: meetingTitle
                        });
                    }
                });
            }

            try {
                // Visualizer
                // 1. Summary
                if (finalData.includeSummary) {
                    let d = new Date(finalData.summaryDate || new Date().toISOString().slice(0, 10));
                    d.setHours(9, 0, 0);
                    calendar.addEvent({
                        id: generateId(),
                        title: meetingTitle,
                        start: d,
                        allDay: true,
                        description: finalData.summary,
                        extendedProps: { description: finalData.summary, isSummary: true, category: batchCategory, sourceId: batchId }
                    });
                }
                // 2. Tasks
                finalData.todo_tasks.forEach(t => {
                    try {
                        let start = new Date(`${t.date}T${t.time}`);
                        if (isNaN(start.getTime())) start = new Date();
                        let end = new Date(start.getTime() + 3600000);
                        calendar.addEvent({
                            id: generateId(),
                            title: t.title,
                            start: start, end: end,
                            description: t.description,
                            extendedProps: { description: t.description, isTask: true, status: 'todo', category: batchCategory, sourceId: t.sourceId, sourceTitle: t.sourceTitle }
                        });
                    } catch (e) { console.error("Task add error", e); }
                });
                // 3. Meetings
                finalData.schedule_items.forEach(m => {
                    try {
                        let start = new Date(`${m.date}T${m.time}`);
                        if (isNaN(start.getTime())) {
                            console.warn("Invalid date", m);
                            return;
                        }
                        let end = new Date(start.getTime() + 3600000);
                        calendar.addEvent({
                            id: generateId(),
                            title: m.title,
                            start: start, end: end,
                            description: m.description,
                            extendedProps: { description: m.description, isMeeting: true, category: batchCategory, sourceId: m.sourceId, sourceTitle: m.sourceTitle }
                        });
                    } catch (e) { console.error("Meeting add error", e); }
                });

                saveEventsToStorage();
                document.getElementById('previewStage').classList.add('hidden');

                const btn = document.querySelector('button[onclick="applyToCalendar()"]');
                const orig = btn.innerHTML;
                btn.innerHTML = "✅ Added!";
                setTimeout(() => btn.innerHTML = orig, 2000);

            } catch (e) {
                alert('Error adding: ' + e.message);
                console.error(e);
            }
        }


    </script>
</body>

</html>