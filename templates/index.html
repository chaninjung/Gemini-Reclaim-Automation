<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¤– íšŒì˜ë¡ ìë™í™” - Smart Scheduler</title>

    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>

    <!-- Toast UI Editor -->
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        .fc-event {
            cursor: pointer;
            transition: all 0.2s;
        }

        .fc-event:hover {
            transform: scale(1.02);
            z-index: 50;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .toastui-editor-defaultUI {
            border: 1px solid #e5e7eb !important;
            border-radius: 0.5rem;
        }

        .toastui-editor-contents {
            font-size: 14px;
            font-family: inherit;
        }

        #contextMenu {
            position: absolute;
            z-index: 1000;
            display: none;
        }

        /* Markdown Preview Style */
        .markdown-preview h1 {
            font-size: 1.4em;
            font-weight: bold;
            margin: 0.8em 0 0.4em 0;
        }

        .markdown-preview h2 {
            font-size: 1.2em;
            font-weight: bold;
            margin: 0.8em 0 0.4em 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 4px;
        }

        .markdown-preview h3 {
            font-size: 1.1em;
            font-weight: bold;
            margin: 0.8em 0 0.4em 0;
        }

        .markdown-preview ul {
            list-style: disc;
            padding-left: 1.2em;
            margin-bottom: 0.5em;
        }

        .markdown-preview ol {
            list-style: decimal;
            padding-left: 1.2em;
            margin-bottom: 0.5em;
        }

        .markdown-preview li {
            margin-bottom: 0.2em;
        }

        .markdown-preview p {
            margin-bottom: 0.8em;
        }

        .markdown-preview strong {
            color: #1d4ed8;
        }
    </style>
</head>

<body class="bg-gray-100 h-screen flex flex-col" onclick="hideContextMenu()">

    <!-- Header -->
    <header class="bg-white shadow-sm h-16 flex items-center px-6 justify-between flex-shrink-0 z-10">
        <div class="flex items-center gap-3">
            <span class="text-2xl">ğŸ¤–</span>
            <h1 class="font-bold text-xl text-gray-800">Smart Scheduler</h1>
            <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">Step-by-Step Workflow</span>
        </div>
        <div class="flex items-center gap-4">
            <button onclick="clearStorage()" class="text-xs text-gray-400 hover:text-red-500 underline">ìƒˆë¡œ ì‹œì‘í•˜ê¸°
                (ì´ˆê¸°í™”)</button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex overflow-hidden">

        <!-- Left Panel: Input & Analysis Preview -->
        <div class="w-2/5 bg-white border-r border-gray-200 flex flex-col bg-gray-50">
            <div class="p-6 flex-1 overflow-y-auto">
                <h2 class="font-semibold text-gray-700 mb-2 flex items-center gap-2">
                    <span
                        class="bg-gray-200 text-gray-700 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold">1</span>
                    <span>íšŒì˜ë¡ ì…ë ¥</span>
                </h2>

                <!-- Expanded Textarea -->
                <textarea id="meetingNotes"
                    class="w-full h-[500px] p-5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none text-sm leading-relaxed shadow-sm mb-4 font-mono"
                    placeholder="ì—¬ê¸°ì— íšŒì˜ë¡ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>

                <div class="flex justify-end gap-2 border-b border-gray-200 pb-6 mb-6">
                    <button onclick="document.getElementById('meetingNotes').value=''"
                        class="px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">ì§€ìš°ê¸°</button>
                    <button onclick="analyzeNotes()" id="analyzeBtn"
                        class="px-6 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors shadow-sm flex items-center gap-2">
                        <span>ğŸš€ 1ì°¨ ë¶„ì„ ì‹œì‘</span>
                    </button>
                </div>

                <!-- Analysis Preview Stage -->
                <div id="previewStage" class="hidden pb-10">
                    <!-- Dynamic Content Area -->
                    <div id="summaryPreview" class="w-full"></div>

                    <!-- Action Button Area -->
                    <div class="flex flex-col gap-2 mt-8 pt-6 border-t border-gray-100">
                        <p class="text-xs text-gray-500 mb-2 text-center">ğŸ‘‡ ì´ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ìŠ¤ì¼€ì¤„ì„ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                        <button onclick="applyToCalendar()"
                            class="w-full py-3 bg-purple-600 text-white text-sm font-bold rounded-lg hover:bg-purple-700 transition-colors shadow-md flex items-center justify-center gap-2">
                            <span>ğŸ“… 4. ìº˜ë¦°ë”/ìŠ¤ì¼€ì¤„ëŸ¬ì— ë°˜ì˜í•˜ê¸°</span>
                        </button>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="loadingState" class="hidden mt-12 text-center">
                    <div
                        class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-blue-500 border-t-transparent">
                    </div>
                    <p class="mt-2 text-sm text-gray-500 animate-pulse">LLMì´ íšŒì˜ë¡ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                </div>
            </div>
        </div>

        <!-- Right Panel: Calendar -->
        <div class="w-3/5 bg-white p-6 overflow-hidden flex flex-col border-l-4 border-gray-100">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-4">
                    <h2 class="font-semibold text-gray-700 flex items-center gap-2">
                        <span
                            class="bg-purple-100 text-purple-700 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold">5</span>
                        <span>ì—…ë¬´ ìº˜ë¦°ë”</span>
                    </h2>
                </div>

                <button onclick="syncToCalcom()" id="syncBtn"
                    class="px-6 py-2 bg-indigo-600 text-white text-sm font-bold rounded-lg hover:bg-indigo-700 transition-colors shadow-md flex items-center gap-2 opacity-50 cursor-not-allowed"
                    disabled>
                    <span>ğŸš€ ìµœì¢… ì™„ë£Œ (Cal.com ë“±ë¡)</span>
                </button>
            </div>

            <div id="syncResultConfig"
                class="mb-4 bg-green-50 rounded border border-green-100 p-3 text-xs text-green-900 hidden flex justify-between items-center">
                <span id="syncResultText"></span>
                <button onclick="this.parentElement.classList.add('hidden')"
                    class="text-green-700 hover:text-green-900">âœ•</button>
            </div>

            <div class="flex-1 bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden text-sm relative">
                <div id='calendar' class="h-full"></div>
            </div>

            <div class="mt-3 flex gap-2 text-xs justify-end items-center">
                <!-- Interactive Legend / Filters -->
                <button onclick="toggleFilter('summary')" id="filter-summary"
                    class="filter-btn active px-3 py-1.5 rounded-full bg-purple-50 text-purple-700 border border-purple-100 font-medium hover:bg-purple-100 transition-all flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-purple-500"></span> íšŒì˜ë¡ ìš”ì•½
                </button>
                <button onclick="toggleFilter('task')" id="filter-task"
                    class="filter-btn active px-3 py-1.5 rounded-full bg-blue-50 text-blue-700 border border-blue-100 font-medium hover:bg-blue-100 transition-all flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-blue-500"></span> íƒœìŠ¤í¬
                </button>
                <button onclick="toggleFilter('meeting')" id="filter-meeting"
                    class="filter-btn active px-3 py-1.5 rounded-full bg-green-50 text-green-700 border border-green-100 font-medium hover:bg-green-100 transition-all flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-green-500"></span> ë¯¸íŒ…
                </button>
            </div>
        </div>

    </main>
    <style>
        /* Notion-like Summary Preview Styling (Modal & Preview) */
        .prose {
            color: #37352f;
            line-height: 1.6;
            font-size: 15px;
        }

        .prose h1 {
            font-size: 1.8em;
            font-weight: 700;
            margin-top: 1em;
            margin-bottom: 0.5em;
            color: #111827;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.3em;
        }

        .prose h2 {
            font-size: 1.5em;
            font-weight: 600;
            margin-top: 1.2em;
            margin-bottom: 0.5em;
            color: #1f2937;
        }

        .prose h3 {
            font-size: 1.25em;
            font-weight: 600;
            margin-top: 1em;
            margin-bottom: 0.5em;
            color: #374151;
        }

        .prose strong {
            font-weight: 600;
            color: #111827;
        }

        .prose ul {
            list-style-type: disc;
            padding-left: 1.5em;
            margin-bottom: 1em;
        }

        .prose ol {
            list-style-type: decimal;
            padding-left: 1.5em;
            margin-bottom: 1em;
        }

        .prose li {
            margin-bottom: 0.25em;
        }

        .prose p {
            margin-bottom: 1em;
        }

        .prose blockquote {
            border-left: 4px solid #e5e7eb;
            padding-left: 1em;
            color: #6b7280;
            font-style: italic;
            margin-bottom: 1em;
        }

        #summaryPreview {
            /* Apply styling to preview as well - duplicating prose styles for compatibility */
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            color: #37352f;
            line-height: 1.6;
        }

        #summaryPreview h1 {
            font-size: 1.8em;
            font-weight: 700;
            margin-top: 1em;
            margin-bottom: 0.5em;
            color: #111827;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.3em;
        }

        #summaryPreview h2 {
            font-size: 1.5em;
            font-weight: 600;
            margin-top: 1.2em;
            margin-bottom: 0.5em;
            color: #1f2937;
        }

        #summaryPreview h3 {
            font-size: 1.25em;
            font-weight: 600;
            margin-top: 1em;
            margin-bottom: 0.5em;
            color: #374151;
        }

        #summaryPreview ul {
            list-style-type: disc;
            padding-left: 1.5em;
            margin-bottom: 1em;
        }

        #summaryPreview li {
            margin-bottom: 0.25em;
        }

        #summaryPreview p {
            margin-bottom: 1em;
        }

        #summaryPreview blockquote {
            border-left: 4px solid #e5e7eb;
            padding-left: 1em;
            color: #6b7280;
            font-style: italic;
            margin-bottom: 1em;
        }

        /* Filter Styles for Calendar Events */
        .calendar-filtered-summary .event-type-summary {
            display: none !important;
        }

        .calendar-filtered-task .event-type-task {
            display: none !important;
        }

        .calendar-filtered-meeting .event-type-meeting {
            display: none !important;
        }

        /* Button Inactive State */
        .filter-btn.inactive {
            background-color: #f3f4f6;
            color: #9ca3af;
            border-color: #e5e7eb;
        }

        .filter-btn.inactive span {
            background-color: #d1d5db;
        }

        /* Modal Context Styling */
        .context-block {
            background-color: #f9fafb;
            border-left: 3px solid #d1d5db;
            padding: 0.75rem 1rem;
            margin-top: 1rem;
            border-radius: 0 0.375rem 0.375rem 0;
            font-size: 0.9em;
            color: #4b5563;
        }

        .context-label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.25rem;
            display: block;
            text-transform: uppercase;
            font-size: 0.75em;
            letter-spacing: 0.05em;
        }

        .context-label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.25rem;
            display: block;
            text-transform: uppercase;
            font-size: 0.75em;
            letter-spacing: 0.05em;
        }
    </style>

    .filter-btn.inactive span {
    background-color: #d1d5db;
    }
    </style>

    <!-- Context Menu -->
    <div id="contextMenu" class="bg-white rounded-lg shadow-xl border border-gray-200 py-1 w-32">
        <button onclick="onClickContextEdit()"
            class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">âœï¸ í¸ì§‘í•˜ê¸°</button>
        <button onclick="onClickContextDelete()"
            class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50">ğŸ—‘ï¸ ì‚­ì œí•˜ê¸°</button>
    </div>

    <!-- Read-Only Event View Modal (Widened) -->
    <div id="viewModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl w-[800px] flex flex-col overflow-hidden max-h-[85vh]">
            <div class="px-8 py-6 border-b border-gray-100 flex justify-between items-start bg-gray-50">
                <div>
                    <h3 id="viewEventTitle" class="text-2xl font-bold text-gray-800 leading-snug"></h3>
                    <p id="viewEventTime" class="text-base text-gray-500 mt-1 font-medium"></p>
                </div>
                <button onclick="closeModal()"
                    class="text-gray-400 hover:text-gray-600 transition-colors p-1 hover:bg-gray-200 rounded">âœ•</button>
            </div>

            <div class="flex-1 p-8 overflow-y-auto bg-white custom-scrollbar">
                <div id="viewEventDesc" class="prose max-w-none text-gray-700 leading-relaxed"></div>
            </div>

            <div class="px-8 py-5 border-t border-gray-100 bg-gray-50 flex justify-end gap-3">
                <button onclick="closeModal()"
                    class="px-5 py-2.5 text-gray-600 hover:bg-gray-200 rounded-lg text-sm font-medium transition-colors">ë‹«ê¸°</button>
                <button onclick="editFromViewModal()"
                    class="px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-bold shadow-sm flex items-center gap-2 transition-colors">
                    <span>âœï¸ ìˆ˜ì •í•˜ê¸°</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Enhanced Event Edit Modal (WYSIWYG) -->
    <div id="eventModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl w-[900px] h-[85vh] flex flex-col overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                <h3 class="text-lg font-bold text-gray-800">ì¼ì • í¸ì§‘</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">âœ•</button>
            </div>

            <div class="flex-1 flex flex-col p-6 overflow-hidden bg-white">
                <input type="hidden" id="editEventId">

                <div class="grid grid-cols-12 gap-4 mb-4">
                    <div class="col-span-12">
                        <label class="block text-xs font-semibold text-gray-500 mb-1">ì œëª©</label>
                        <input type="text" id="editEventTitle"
                            class="w-full text-lg font-bold border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none"
                            placeholder="ì œëª© ì—†ìŒ">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-xs font-semibold text-gray-500 mb-1">ì‹œì‘ ì‹œê°„</label>
                        <input type="datetime-local" id="editEventStart"
                            class="w-full text-sm border border-gray-300 rounded px-3 py-2 bg-gray-50 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-500 mb-1">ì¢…ë£Œ ì‹œê°„</label>
                        <input type="datetime-local" id="editEventEnd"
                            class="w-full text-sm border border-gray-300 rounded px-3 py-2 bg-gray-50 outline-none">
                    </div>
                </div>

                <div class="flex-1 flex flex-col min-h-0 border border-t border-gray-200 pt-2">
                    <label class="block text-xs font-semibold text-gray-500 mb-2">ìƒì„¸ ë‚´ìš© (WYSIWYG)</label>
                    <div id="editor" class="flex-1"></div>
                </div>
            </div>

            <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 flex justify-between items-center">
                <button onclick="deleteEvent()"
                    class="text-red-500 text-sm hover:text-red-700 font-medium px-2">ì‚­ì œí•˜ê¸°</button>
                <div class="flex gap-3">
                    <button onclick="closeModal()"
                        class="px-5 py-2 text-gray-600 hover:bg-gray-200 rounded-lg text-sm font-medium">ì·¨ì†Œ</button>
                    <button onclick="saveEventChanges()"
                        class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-bold shadow-sm">ì €ì¥í•˜ê¸°</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let calendar;
        let editor;
        const STORAGE_KEY_EVENTS = 'smart_scheduler_events';
        const STORAGE_KEY_NOTES = 'smart_scheduler_notes';

        // ì¤‘ìš”: ë‹¨ê³„ë³„ ë°ì´í„° íë¦„ì„ ìœ„í•œ ì„ì‹œ ì €ì¥ì†Œ
        let tempAnalysisResult = null;

        let activeEvent = null;
        let contextEvent = null;

        document.addEventListener('DOMContentLoaded', function () {
            editor = new toastui.Editor({
                el: document.querySelector('#editor'),
                height: '100%',
                initialEditType: 'wysiwyg',
                previewStyle: 'vertical'
            });

            // Load data from server
            loadDataFromServer();

            var calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                views: {
                    dayGridMonth: {
                        displayEventTime: false
                    }
                },
                locale: 'ko',
                slotMinTime: '08:00:00',
                slotMaxTime: '22:00:00',
                allDaySlot: false,
                nowIndicator: true,
                height: '100%',
                expandRows: true,
                editable: true,
                droppable: true,
                selectable: true,
                droppable: true,
                selectable: true,
                events: [], // Initial empty, will be loaded from server

                eventDidMount: function (info) {
                    info.el.addEventListener('contextmenu', function (e) {
                        e.preventDefault();
                        showContextMenu(e, info.event);
                    });

                    let tipContent = info.event.extendedProps.description || '';
                    if (tipContent.length > 200) tipContent = tipContent.substring(0, 200) + '...';

                    tippy(info.el, {
                        content: `<div class="text-xs p-1 max-w-xs overflow-hidden"><strong class="block text-sm mb-1">${info.event.title}</strong><p class="text-gray-300 italic text-[10px]">ìš°í´ë¦­í•˜ì—¬ ìˆ˜ì •/ì‚­ì œ</p></div>`,
                        allowHTML: true,
                        theme: 'translucent',
                        placement: 'auto',
                    });
                },

                eventDrop: function () { saveEventsToStorage(); },
                eventResize: function () { saveEventsToStorage(); },
                eventClick: function (info) { showReadOnlyModal(info); }
            });
            calendar.render();

            // ìº˜ë¦°ë”ì— ì´ë²¤íŠ¸ê°€ ìˆìœ¼ë©´ ë“±ë¡ ë²„íŠ¼ í™œì„±í™”
            checkSyncButtonState();

            // Debounced Save for Meeting Notes
            let notesTimeout;
            document.getElementById('meetingNotes').addEventListener('input', function (e) {
                clearTimeout(notesTimeout);
                notesTimeout = setTimeout(() => {
                    saveDataToServer({ meeting_notes: e.target.value });
                }, 1000); // 1 second debounce
            });
        });

        // --- Server Persistence Logic ---
        async function loadDataFromServer() {
            try {
                const response = await fetch('/api/db');
                const result = await response.json();
                if (result.success) {
                    // Restore Meeting Notes
                    if (result.data.meeting_notes) {
                        document.getElementById('meetingNotes').value = result.data.meeting_notes;
                    }

                    // Restore Calendar Events
                    if (result.data.events) {
                        calendar.removeAllEvents();
                        calendar.addEventSource(result.data.events);
                    }
                    checkSyncButtonState();
                }
            } catch (error) {
                console.error('Failed to load data:', error);
            }
        }

        async function saveDataToServer(data) {
            try {
                await fetch('/api/db', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            } catch (error) {
                console.error('Failed to save data:', error);
            }
        }

        // --- Context Menu ---
        function showContextMenu(e, event) {
            contextEvent = event;
            const menu = document.getElementById('contextMenu');
            menu.style.display = 'block';
            menu.style.left = e.pageX + 'px';
            menu.style.top = e.pageY + 'px';
        }

        function hideContextMenu() { document.getElementById('contextMenu').style.display = 'none'; }

        function onClickContextEdit() {
            if (contextEvent) openEditModal(contextEvent);
            hideContextMenu();
        }

        function onClickContextDelete() {
            if (contextEvent && confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                contextEvent.remove();
                saveEventsToStorage();
                checkSyncButtonState();
            }
            hideContextMenu();
        }

        // --- Modal ---
        function openEditModal(event) {
            activeEvent = event;
            document.getElementById('editEventId').value = event.id;
            document.getElementById('editEventTitle').value = event.title;

            const toLocalISO = (date) => {
                const tzOffset = date.getTimezoneOffset() * 60000;
                return (new Date(date - tzOffset)).toISOString().slice(0, 16);
            };

            document.getElementById('editEventStart').value = toLocalISO(event.start);
            document.getElementById('editEventEnd').value = event.end ? toLocalISO(event.end) : toLocalISO(new Date(event.start.getTime() + 3600000));
            editor.setMarkdown(event.extendedProps.description || '');
            document.getElementById('eventModal').classList.remove('hidden');
            setTimeout(() => editor.refresh(), 100);
        }

        function closeModal() { document.getElementById('eventModal').classList.add('hidden'); activeEvent = null; }

        function saveEventChanges() {
            if (activeEvent) {
                const newTitle = document.getElementById('editEventTitle').value;
                const newDesc = editor.getMarkdown();
                const newStart = new Date(document.getElementById('editEventStart').value);
                const newEnd = new Date(document.getElementById('editEventEnd').value);

                activeEvent.setProp('title', newTitle);
                activeEvent.setExtendedProp('description', newDesc);
                activeEvent.setStart(newStart);
                activeEvent.setEnd(newEnd);

                saveEventsToStorage();
                closeModal();
                calendar.gotoDate(newStart);
            }
        }

        function deleteEvent() {
            if (activeEvent && confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                activeEvent.remove();
                saveEventsToStorage();
                checkSyncButtonState();
                closeModal();
            }
        }

        function saveEventsToStorage() {
            const events = calendar.getEvents().map(e => ({
                id: e.id,
                title: e.title,
                start: e.startStr,
                end: e.endStr,
                color: e.backgroundColor,
                extendedProps: e.extendedProps
            }));

            // Save to Server
            saveDataToServer({ events: events });

            checkSyncButtonState();
        }

        function checkSyncButtonState() {
            const btn = document.getElementById('syncBtn');
            const hasEvents = calendar.getEvents().length > 0;
            if (hasEvents) {
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        function clearStorage() {
            if (confirm('ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ê³  ìƒˆë¡œ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                // localStorage.clear(); // No longer used
                saveDataToServer({ meeting_notes: "", events: [] }).then(() => {
                    location.reload();
                });
            }
        }

        // --- STEP 1: Analyze ---
        async function analyzeNotes() {
            const notes = document.getElementById('meetingNotes').value;
            if (!notes.trim()) { alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('previewStage').classList.add('hidden');

            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `meeting_notes=${encodeURIComponent(notes)}&auto_sync=false`
                });

                const data = await response.json();

                if (data.success) {
                    tempAnalysisResult = data.analysis;
                    document.getElementById('previewStage').classList.remove('hidden');
                    renderStagingArea(data.analysis);
                } else {
                    alert('ì˜¤ë¥˜: ' + data.error);
                }

            } catch (error) {
                alert('ì„œë²„ ì˜¤ë¥˜: ' + error);
            } finally {
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('analyzeBtn').disabled = false;
            }
        }

        // --- Staging Area Rendering ---
        // --- Staging Area Rendering (Refined & Clean UI) ---
        function renderStagingArea(analysis) {
            const container = document.getElementById('summaryPreview');
            container.innerHTML = ''; // Clear previous

            // 1. Summary Section (Step 2: Meeting Summary)
            // Full width to match input area, clean simple header.
            const summaryHTML = `
                <div class="mb-8">
                    <div class="flex items-center gap-2 mb-3">
                         <span class="flex items-center justify-center w-6 h-6 rounded-full bg-purple-100 text-purple-600 text-xs font-bold">2</span>
                         <h3 class="text-lg font-bold text-gray-800">íšŒì˜ë¡ ìš”ì•½ (Summary)</h3>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden group hover:shadow-md transition-shadow duration-300">
                        <div class="p-4 border-b border-gray-50 bg-gray-50/50 flex items-center justify-between">
                             <label class="flex items-center space-x-2 cursor-pointer select-none">
                                <input type="checkbox" id="checkSummary" checked class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500 border-gray-300">
                                <span class="font-semibold text-gray-700">ìº˜ë¦°ë” ì„¤ëª…ì— í¬í•¨</span>
                            </label>
                            <span class="text-xs text-gray-400">Markdown Supported</span>
                        </div>
                        <div class="p-0">
                            <textarea id="editSummary" 
                                class="w-full h-[400px] p-5 border-none text-sm leading-relaxed text-gray-700 placeholder-gray-400 focus:ring-0 focus:outline-none resize-y bg-white font-mono"
                                placeholder="ìš”ì•½ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...">${analysis.summary}</textarea>
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML += summaryHTML;

            // Default Scheduling Logic (Tomorrow 9 AM start)
            let baseDate = new Date();
            baseDate.setDate(baseDate.getDate() + 1);
            baseDate.setHours(9, 0, 0, 0);

            // Container for Step 3: Tasks & Meetings (Combined)
            let step3HTML = `
                <div class="mb-8">
                    <div class="flex items-center gap-2 mb-3">
                         <span class="flex items-center justify-center w-6 h-6 rounded-full bg-blue-100 text-blue-600 text-xs font-bold">3</span>
                         <h3 class="text-lg font-bold text-gray-800">íƒœìŠ¤í¬ & ë¯¸íŒ… (Tasks & Meetings)</h3>
                    </div>
                    <div class="space-y-6">
            `;

            // 2. Tasks Section (Inside Step 3)
            if (analysis.todo_tasks && analysis.todo_tasks.length > 0) {
                step3HTML += `
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="px-5 py-3 border-b border-gray-50 bg-blue-50/30 flex items-center gap-2">
                            <span class="text-blue-600 font-bold text-sm">Tasks</span>
                            <span class="bg-blue-100 text-blue-600 text-xs px-2 py-0.5 rounded-full">${analysis.todo_tasks.length}</span>
                        </div>
                        <div class="divide-y divide-gray-100">
                `;

                analysis.todo_tasks.forEach((task, idx) => {
                    // Logic: Auto-increment time for each task
                    let taskDate = new Date(baseDate);
                    taskDate.setHours(baseDate.getHours() + idx);
                    if (taskDate.getHours() >= 18) {
                        taskDate.setDate(taskDate.getDate() + 1);
                        taskDate.setHours(9 + (idx % 9), 0, 0);
                    }
                    const yyyy = taskDate.getFullYear();
                    const mm = String(taskDate.getMonth() + 1).padStart(2, '0');
                    const dd = String(taskDate.getDate()).padStart(2, '0');
                    const dateStr = `${yyyy}-${mm}-${dd}`;
                    const timeStr = String(taskDate.getHours()).padStart(2, '0') + ':00';

                    step3HTML += `
                        <div class="p-5 hover:bg-gray-50 transition-colors group">
                            <div class="flex items-start gap-3">
                                <div class="pt-1">
                                    <input type="checkbox" id="checkTask_${idx}" checked class="w-5 h-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500 cursor-pointer">
                                </div>
                                <div class="flex-1 min-w-0">
                                    <!-- Content (Title & Desc) -->
                                    <div class="flex flex-col gap-1 mb-2">
                                        <input type="text" id="valTaskTitle_${idx}" value="${task.title}" 
                                            class="w-full font-bold text-gray-800 text-base bg-transparent border-none p-0 focus:ring-0 placeholder-gray-300 group-hover:text-blue-700 transition-colors" placeholder="íƒœìŠ¤í¬ ì œëª©">
                                        <input type="text" id="valTaskDesc_${idx}" value="${task.description}" 
                                            class="w-full text-sm text-gray-500 bg-transparent border-none p-0 focus:ring-0 placeholder-gray-300 resize-none" placeholder="ìƒì„¸ ë‚´ìš©">
                                        <input type="hidden" id="valTaskContext_${idx}" value="${task.context || ''}">
                                        <input type="hidden" id="valTaskTime_${idx}" value="${timeStr}">
                                    </div>
                                    
                                    <!-- Date Control (Aligned Right Below Content) -->
                                    <div class="flex justify-end pt-2 border-t border-gray-50 border-dashed mt-1">
                                         <div class="flex items-center gap-2">
                                            <span class="text-xs text-gray-400 font-medium">Date:</span>
                                            <input type="date" id="valTaskDate_${idx}" value="${dateStr}" 
                                                class="text-xs bg-gray-50 border border-gray-200 rounded px-2 py-1 text-gray-600 font-mono focus:border-blue-300 focus:ring-1 focus:ring-blue-200 transition-all cursor-pointer hover:border-gray-300">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                step3HTML += `</div></div>`;
            }

            // 3. Meetings Section (Inside Step 3)
            if (analysis.schedule_items && analysis.schedule_items.length > 0) {
                step3HTML += `
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="px-5 py-3 border-b border-gray-50 bg-green-50/30 flex items-center gap-2">
                            <span class="text-green-600 font-bold text-sm">Meetings</span>
                            <span class="bg-green-100 text-green-600 text-xs px-2 py-0.5 rounded-full">${analysis.schedule_items.length}</span>
                        </div>
                        <div class="divide-y divide-gray-100">
                `;
                analysis.schedule_items.forEach((item, idx) => {
                    step3HTML += `
                         <div class="p-5 hover:bg-gray-50 transition-colors group">
                            <div class="flex items-start gap-3">
                                <div class="pt-1">
                                    <input type="checkbox" id="checkSched_${idx}" checked class="w-5 h-5 text-green-600 rounded border-gray-300 focus:ring-green-500 cursor-pointer">
                                </div>
                                <div class="flex-1 min-w-0">
                                    <!-- Content (Title & Desc) -->
                                    <div class="flex flex-col gap-1 mb-2">
                                        <input type="text" id="valSchedTitle_${idx}" value="${item.title}" 
                                             class="w-full font-bold text-gray-800 text-base bg-transparent border-none p-0 focus:ring-0 placeholder-gray-300 group-hover:text-green-700 transition-colors" placeholder="ë¯¸íŒ… ì œëª©">
                                        <input type="text" id="valSchedDesc_${idx}" value="${item.description}" 
                                            class="w-full text-sm text-gray-500 bg-transparent border-none p-0 focus:ring-0 placeholder-gray-300" placeholder="ìƒì„¸ ë‚´ìš©">
                                        <input type="hidden" id="valSchedContext_${idx}" value="${item.context || ''}">
                                        <input type="hidden" id="valSchedTime_${idx}" value="${item.time}">
                                    </div>
                                    
                                     <!-- Date Control (Aligned Right Below Content) -->
                                    <div class="flex justify-end pt-2 border-t border-gray-50 border-dashed mt-1">
                                        <div class="flex items-center gap-2">
                                            <span class="text-xs text-gray-400 font-medium">Date:</span>
                                            <input type="date" id="valSchedDate_${idx}" value="${item.date}" 
                                                class="text-xs bg-gray-50 border border-gray-200 rounded px-2 py-1 text-gray-600 font-mono focus:border-green-300 focus:ring-1 focus:ring-green-200 transition-all cursor-pointer hover:border-gray-300">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                step3HTML += `</div></div>`;
            }

            step3HTML += `</div></div>`; // Close Step 3 container
            container.innerHTML += step3HTML;
        }

        // --- STEP 2: Apply to Calendar (No Confirmation) ---
        function applyToCalendar() {
            if (!tempAnalysisResult) {
                alert("ë¶„ì„ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            // Collect Data from Staging Area
            const finalData = { ...tempAnalysisResult }; // Clone base structure

            // 1. Summary
            const summaryCheck = document.getElementById('checkSummary');
            if (summaryCheck && summaryCheck.checked) {
                finalData.summary = document.getElementById('editSummary').value;
                finalData.includeSummary = true;
            } else {
                finalData.includeSummary = false;
            }

            // 2. Tasks
            finalData.todo_tasks = [];
            if (tempAnalysisResult.todo_tasks) {
                tempAnalysisResult.todo_tasks.forEach((_, idx) => {
                    const chk = document.getElementById(`checkTask_${idx}`);
                    if (chk && chk.checked) {
                        const baseTitle = document.getElementById(`valTaskTitle_${idx}`).value;
                        const baseDesc = document.getElementById(`valTaskDesc_${idx}`).value;
                        const context = document.getElementById(`valTaskContext_${idx}`).value;

                        // Append context to description if exists
                        const fullDesc = context ? `${baseDesc}\n\n[Context]\n${context}` : baseDesc;

                        finalData.todo_tasks.push({
                            title: baseTitle,
                            description: fullDesc,
                            date: document.getElementById(`valTaskDate_${idx}`).value,
                            time: document.getElementById(`valTaskTime_${idx}`).value
                        });
                    }
                });
            }

            // 3. Schedules
            finalData.schedule_items = [];
            if (tempAnalysisResult.schedule_items) {
                tempAnalysisResult.schedule_items.forEach((_, idx) => {
                    const chk = document.getElementById(`checkSched_${idx}`);
                    if (chk && chk.checked) {
                        const baseTitle = document.getElementById(`valSchedTitle_${idx}`).value;
                        const baseDesc = document.getElementById(`valSchedDesc_${idx}`).value;
                        const context = document.getElementById(`valSchedContext_${idx}`).value;
                        // Append context to description if exists
                        const fullDesc = context ? `${baseDesc}\n\n[Context]\n${context}` : baseDesc;

                        finalData.schedule_items.push({
                            title: baseTitle,
                            date: document.getElementById(`valSchedDate_${idx}`).value,
                            time: document.getElementById(`valSchedTime_${idx}`).value,
                            description: fullDesc,
                            duration_minutes: 60
                        });
                    }
                });
            }

            // Validation
            if (!finalData.includeSummary && finalData.todo_tasks.length === 0 && finalData.schedule_items.length === 0) {
                alert("ì„ íƒëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤. ìº˜ë¦°ë”ì— ì¶”ê°€í•  í•­ëª©ì„ ì²´í¬í•´ì£¼ì„¸ìš”.");
                return;
            }

            // Direct Apply (No Confirm Dialog)
            visualizeCalendarV3(finalData);
            document.getElementById('previewStage').classList.add('hidden'); // Clear staging

            // Show subtle feedback
            const btn = document.querySelector('button[onclick="applyToCalendar()"]');
            const originalText = btn.innerHTML;
            btn.innerText = "âœ… ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤!";
            setTimeout(() => {
                btn.innerHTML = originalText;
            }, 2000);
        }

        // --- STEP 3: Sync ---
        async function syncToCalcom() {
            const events = calendar.getEvents().map(e => ({
                title: e.title,
                start: e.startStr,
                end: e.endStr,
                description: e.extendedProps.description
            }));

            if (events.length === 0) return;

            const btn = document.getElementById('syncBtn');
            const resultDiv = document.getElementById('syncResultConfig');
            const resultMsg = document.getElementById('syncResultText');

            const origText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span>â³ ì €ì¥ ì¤‘...</span>';
            resultDiv.classList.add('hidden');

            try {
                const response = await fetch('/sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ calendar_events: events })
                });

                const data = await response.json();

                if (data.success) {
                    const count = (data.sync_results.tasks_created?.length || 0) + (data.sync_results.events_created?.length || 0);
                    resultMsg.innerText = `âœ… Cal.comì— ${count}ê±´ ë“±ë¡ ì™„ë£Œ!`;
                    resultDiv.classList.remove('hidden');
                } else {
                    alert('ì˜¤ë¥˜: ' + data.error);
                }

            } catch (error) {
                alert('ì„œë²„ ì˜¤ë¥˜: ' + error);
            } finally {
                btn.disabled = false;
                btn.innerHTML = origText;
            }
        }

        function visualizeCalendar(analysis) {
            // ì´ë²ˆì—ëŠ” removeAllEvents()ë¥¼ í˜¸ì¶œí•˜ì§€ ì•Šê³  ì¶”ê°€(Add) ëª¨ë“œë¡œ ê°ˆ ìˆ˜ë„ ìˆì§€ë§Œ,
            // ì‚¬ìš©ìê°€ "ìƒˆ ë¶„ì„"ì„ í–ˆë‹¤ë©´ ë³´í†µ ë¦¬ì…‹ì„ ì›í•  ìˆ˜ ìˆìŒ. 
            // í•˜ì§€ë§Œ ì‚¬ìš©ìê°€ "ê¸°ì¡´ ì¼ì • ìœ ì§€"ë¥¼ ì›í•  ìˆ˜ë„ ìˆìœ¼ë‹ˆ removeAllEventsëŠ” ì„ íƒì ì´ì–´ì•¼ í•˜ëŠ”ë°,
            // ì¼ë‹¨ì€ ê¹”ë”í•œ workflowë¥¼ ìœ„í•´ ê¸°ì¡´ ì¼ì • ìœ ì§€í•˜ë©° ì¶”ê°€. (ì‚¬ìš©ìê°€ ì›í•˜ë©´ ì „ì²´ì‚­ì œ ë²„íŠ¼ ì“°ë©´ ë¨)

            // 1. íšŒì˜ë¡ ìš”ì•½ ì´ë²¤íŠ¸
            let meetingDate = new Date();
            meetingDate.setHours(new Date().getHours() + 1, 0, 0, 0);

            const patterns = [/(\d{4})ë…„\s*(\d{1,2})ì›”\s*(\d{1,2})ì¼/, /(\d{4})\.(\d{1,2})\.(\d{1,2})/, /(\d{4})-(\d{1,2})-(\d{1,2})/];
            for (let pattern of patterns) {
                const match = analysis.summary.match(pattern);
                if (match) {
                    meetingDate = new Date(match[1], match[2] - 1, match[3]);
                    meetingDate.setHours(10, 0, 0, 0);
                    break;
                }
            }
            let summaryEnd = new Date(meetingDate);
            summaryEnd.setHours(summaryEnd.getHours() + 1);
            let summaryTitle = analysis.meeting_title || `ğŸ“ íšŒì˜ë¡ ìš”ì•½`;
            let metaHeader = `**ì°¸ì„ì**: ${analysis.participants?.join(', ') || 'ë¯¸ì •'}\n**í•µì‹¬ ì£¼ì œ**: ${analysis.key_decisions?.join(', ') || 'ì—†ìŒ'}\n\n---\n\n`;

            calendar.addEvent({
                title: summaryTitle,
                start: meetingDate,
                end: summaryEnd,
                color: '#8B5CF6',
                description: metaHeader + analysis.summary,
                extendedProps: { description: metaHeader + analysis.summary, isSummary: true }
            });

            // 2. íƒœìŠ¤í¬
            const tasks = analysis.todo_tasks || [];
            if (tasks.length > 0) {
                let startTime = new Date(meetingDate);
                startTime.setDate(startTime.getDate() + 1);
                startTime.setHours(9, 0, 0, 0);

                tasks.forEach((task, index) => {
                    let eventStart = new Date(startTime);
                    eventStart.setHours(eventStart.getHours() + index);
                    if (eventStart.getHours() >= 18) {
                        eventStart.setDate(eventStart.getDate() + 1);
                        eventStart.setHours(9 + (index % 9), 0, 0);
                    }
                    let eventEnd = new Date(eventStart);
                    eventEnd.setHours(eventEnd.getHours() + 1);

                    calendar.addEvent({
                        title: `[T] ${task.title}`,
                        start: eventStart,
                        end: eventEnd,
                        color: '#3B82F6',
                        description: task.description,
                        extendedProps: { description: task.description }
                    });
                });
            }

            // 3. ë¯¸íŒ…
            const schedules = analysis.schedule_items || [];
            schedules.forEach(item => {
                if (item.date && item.time) {
                    let start = new Date(`${item.date}T${item.time}`);
                    let end = new Date(start);
                    end.setMinutes(end.getMinutes() + (item.duration_minutes || 60));

                    calendar.addEvent({
                        title: `[M] ${item.title}`,
                        start: start,
                        end: end,
                        color: '#10B981',
                        description: item.description,
                        extendedProps: { description: item.description }
                    });
                }
            });
            saveEventsToStorage();
        }
        // --- NEW: Read-Only View Logic ---
        function showReadOnlyModal(info) {
            activeEvent = info.event;
            const props = activeEvent.extendedProps;

            document.getElementById('viewEventTitle').innerText = activeEvent.title;

            // Format time range
            const start = activeEvent.start;
            const end = activeEvent.end || start;
            const options = { year: 'numeric', month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            const timeStr = start.toLocaleString(undefined, options) + ' ~ ' + end.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
            document.getElementById('viewEventTime').innerText = timeStr;

            // Render Description (Markdown support)
            let desc = props.description || '';

            // Handle [Context] formatting logic
            if (desc.includes('[Context]')) {
                const parts = desc.split('[Context]');
                let mainContent = parts[0].trim();
                let contextContent = parts[1] ? parts[1].trim() : '';

                if (contextContent) {
                    mainContent = (typeof marked !== 'undefined') ? marked.parse(mainContent) : mainContent.replace(/\n/g, '<br>');
                    desc = `
                        <div>${mainContent}</div>
                        <div class="context-block">
                            <span class="context-label">ğŸ“Œ ê´€ë ¨ ë¬¸ë§¥ (Context)</span>
                            <div class="text-gray-600">${contextContent}</div>
                        </div>
                     `;
                } else {
                    desc = (typeof marked !== 'undefined') ? marked.parse(desc) : desc.replace(/\n/g, '<br>');
                }
                document.getElementById('viewEventDesc').innerHTML = desc;
            } else {
                document.getElementById('viewEventDesc').innerHTML = (typeof marked !== 'undefined') ? marked.parse(desc) : desc.replace(/\n/g, '<br>');
            }

            document.getElementById('viewModal').classList.remove('hidden');
        }

        function editFromViewModal() {
            document.getElementById('viewModal').classList.add('hidden');
            openEditModal(activeEvent);
        }

        // Override closeModal to handle both
        function closeModal() {
            document.getElementById('eventModal').classList.add('hidden');
            document.getElementById('viewModal').classList.add('hidden');
        }

        // --- NEW: V2 Visualization (Corrected for Staging Area) ---
        function visualizeCalendarV2(analysis) {
            // 1. íšŒì˜ë¡ ìš”ì•½ ì´ë²¤íŠ¸
            if (analysis.includeSummary) {
                let meetingDate = new Date();
                meetingDate.setDate(meetingDate.getDate() + 1);
                meetingDate.setHours(10, 0, 0, 0);

                const patterns = [/(\d{4})ë…„\s*(\d{1,2})ì›”\s*(\d{1,2})ì¼/, /(\d{4})\.(\d{1,2})\.(\d{1,2})/, /(\d{4})-(\d{1,2})-(\d{1,2})/];
                for (let pattern of patterns) {
                    const match = analysis.summary.match(pattern);
                    if (match) {
                        meetingDate = new Date(match[1], match[2] - 1, match[3]);
                        meetingDate.setHours(10, 0, 0, 0);
                        break;
                    }
                }

                let summaryEnd = new Date(meetingDate);
                summaryEnd.setHours(summaryEnd.getHours() + 1);
                let summaryTitle = analysis.meeting_title || `ğŸ“ íšŒì˜ë¡ ìš”ì•½`;
                let metaHeader = `**ì°¸ì„ì**: ${analysis.participants?.join(', ') || 'ë¯¸ì •'}\n**í•µì‹¬ ì£¼ì œ**: ${analysis.key_decisions?.join(', ') || 'ì—†ìŒ'}\n\n---\n\n`;

                calendar.addEvent({
                    title: summaryTitle,
                    start: meetingDate,
                    end: summaryEnd,
                    color: '#8B5CF6',
                    description: metaHeader + analysis.summary,
                    extendedProps: { description: metaHeader + analysis.summary, isSummary: true }
                });
            }

            // 2. íƒœìŠ¤í¬
            const tasks = analysis.todo_tasks || [];
            if (tasks.length > 0) {
                let startTime = new Date();
                startTime.setDate(startTime.getDate() + 1);
                startTime.setHours(9, 0, 0, 0);

                tasks.forEach((task, index) => {
                    let eventStart = new Date(startTime);
                    eventStart.setHours(eventStart.getHours() + index);

                    if (eventStart.getHours() >= 18) {
                        eventStart.setDate(eventStart.getDate() + 1);
                        eventStart.setHours(9 + (index % 9), 0, 0);
                    }
                    let eventEnd = new Date(eventStart);
                    eventEnd.setHours(eventEnd.getHours() + 1);

                    calendar.addEvent({
                        title: `[T] ${task.title}`,
                        start: eventStart,
                        end: eventEnd,
                        color: '#3B82F6',
                        description: task.description,
                        extendedProps: { description: task.description }
                    });
                });
            }

            // 3. ì¼ì • ì•„ì´í…œ ì¶”ê°€
            const schedules = analysis.schedule_items || [];
            schedules.forEach(item => {
                if (item.date && item.time) {
                    let start = new Date(`${item.date}T${item.time}`);
                    let end = new Date(start);
                    end.setMinutes(end.getMinutes() + (item.duration_minutes || 60));

                    calendar.addEvent({
                        title: `[M] ${item.title}`,
                        start: start,
                        end: end,
                        color: '#10B981',
                        description: item.description,
                        extendedProps: { description: item.description }
                    });
                }
            });

            saveEventsToStorage();
        }
        // --- NEW: V3 Visualization (With Explicit Date Support) ---
        // --- NEW: V3 Visualization (With Explicit Date Support & Filtering Classes) ---
        function visualizeCalendarV3(analysis) {
            // 1. íšŒì˜ë¡ ìš”ì•½ ì´ë²¤íŠ¸
            if (analysis.includeSummary) {
                let meetingDate = new Date();
                meetingDate.setDate(meetingDate.getDate() + 1);
                meetingDate.setHours(10, 0, 0, 0);

                const patterns = [/(\d{4})ë…„\s*(\d{1,2})ì›”\s*(\d{1,2})ì¼/, /(\d{4})\.(\d{1,2})\.(\d{1,2})/, /(\d{4})-(\d{1,2})-(\d{1,2})/];
                for (let pattern of patterns) {
                    const match = analysis.summary.match(pattern);
                    if (match) {
                        meetingDate = new Date(match[1], match[2] - 1, match[3]);
                        meetingDate.setHours(10, 0, 0, 0);
                        break;
                    }
                }

                let summaryEnd = new Date(meetingDate);
                summaryEnd.setHours(summaryEnd.getHours() + 1);
                let summaryTitle = analysis.meeting_title || `ğŸ“ íšŒì˜ë¡ ìš”ì•½`;
                // Check if header exists to avoid double adding
                let metaHeader = `**ì°¸ì„ì**: ${analysis.participants?.join(', ') || 'ë¯¸ì •'}\n**í•µì‹¬ ì£¼ì œ**: ${analysis.key_decisions?.join(', ') || 'ì—†ìŒ'}\n\n---\n\n`;
                let desc = analysis.summary;
                if (!desc.includes('**ì°¸ì„ì**:')) {
                    desc = metaHeader + desc;
                }

                calendar.addEvent({
                    title: summaryTitle,
                    start: meetingDate,
                    end: summaryEnd,
                    color: '#8B5CF6',
                    classNames: ['event-type-summary'], // Filtering Class
                    description: desc,
                    extendedProps: { description: desc, isSummary: true, type: 'summary' }
                });
            }

            // 2. íƒœìŠ¤í¬ (Explicit Dates)
            const tasks = analysis.todo_tasks || [];
            if (tasks.length > 0) {
                tasks.forEach((task) => {
                    let eventStart;
                    if (task.date && task.time) {
                        eventStart = new Date(`${task.date}T${task.time}`);
                    } else {
                        // Fallback logic
                        eventStart = new Date();
                        if (task.date) {
                            const datePart = new Date(task.date);
                            eventStart = new Date(datePart);
                            eventStart.setHours(9, 0, 0, 0);
                        } else {
                            eventStart.setDate(eventStart.getDate() + 1);
                            eventStart.setHours(9, 0, 0, 0);
                        }
                    }

                    let eventEnd = new Date(eventStart);
                    eventEnd.setHours(eventEnd.getHours() + 1);

                    calendar.addEvent({
                        title: `[T] ${task.title}`,
                        start: eventStart,
                        end: eventEnd,
                        color: '#3B82F6',
                        classNames: ['event-type-task'], // Filtering Class
                        description: task.description,
                        extendedProps: { description: task.description, type: 'task' }
                    });
                });
            }

            // 3. ë¯¸íŒ…
            const schedules = analysis.schedule_items || [];
            if (schedules.length > 0) {
                schedules.forEach(item => {
                    let start;
                    if (item.date && item.time) {
                        start = new Date(`${item.date}T${item.time}`);
                    } else {
                        start = new Date();
                        if (item.date) {
                            const datePart = new Date(item.date);
                            start = new Date(datePart);
                            start.setHours(10, 0, 0, 0);
                        } else {
                            start.setDate(start.getDate() + 1);
                            start.setHours(10, 0, 0, 0);
                        }
                    }

                    let end = new Date(start);
                    end.setMinutes(end.getMinutes() + (item.duration_minutes || 60));

                    calendar.addEvent({
                        title: `[M] ${item.title}`,
                        start: start,
                        end: end,
                        color: '#10B981',
                        classNames: ['event-type-meeting'], // Filtering Class
                        description: item.description,
                        extendedProps: { description: item.description, type: 'meeting' }
                    });
                });
            }

            saveEventsToStorage();

            // Re-apply filters after adding new events
            Object.keys(activeFilters).forEach(type => {
                if (!activeFilters[type]) {
                    const wrapper = document.getElementById('calendar');
                    wrapper.classList.add(`calendar-filtered-${type}`);
                }
            });
        }

        // --- NEW: Filter Logic ---
        const activeFilters = { summary: true, task: true, meeting: true };

        function toggleFilter(type) {
            const btn = document.getElementById(`filter-${type}`);

            activeFilters[type] = !activeFilters[type];

            // Toggle Button State
            if (activeFilters[type]) {
                btn.classList.remove('inactive');
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
                btn.classList.add('inactive');
            }

            // Toggle CSS Class on Calendar Container (to hide events)
            const wrapper = document.getElementById('calendar');
            if (activeFilters[type]) {
                wrapper.classList.remove(`calendar-filtered-${type}`);
            } else {
                wrapper.classList.add(`calendar-filtered-${type}`);
            }
        }
    </script>
</body>

</html>